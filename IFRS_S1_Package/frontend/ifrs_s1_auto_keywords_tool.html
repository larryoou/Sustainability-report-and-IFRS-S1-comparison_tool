<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>IFRS S1 自動關鍵詞比對工具</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Ctext y='14' font-size='14'%3E%F0%9F%93%84%3C/text%3E%3C/svg%3E">
    <!-- PDF.js (Offline-first with CDN fallback) -->
    <script>
        (function() {
            function setWorker(src) {
                console.log(`🔧 設置 PDF Worker: ${src}`);
                if (window.pdfjsLib) {
                    window.pdfjsLib.GlobalWorkerOptions.workerSrc = src;
                    window.pdfWorkerSrcOverride = src;
                    console.log('✅ PDF Worker 設置完成');
                } else {
                    console.warn('⚠️ pdfjsLib 尚未載入，稍後重試...');
                    // 如果 pdfjsLib 還沒載入，稍後重試
                    setTimeout(() => {
                        if (window.pdfjsLib) {
                            window.pdfjsLib.GlobalWorkerOptions.workerSrc = src;
                            window.pdfWorkerSrcOverride = src;
                            console.log('✅ PDF Worker 延遲設置完成');
                        }
                    }, 100);
                }
            }
            function initializePdfJS() {
                // 確保 pdfjsLib 已載入
                if (typeof window.pdfjsLib !== 'undefined') {
                    console.log('✅ PDF.js 初始化完成');
                    window.pdfJsReady = true;
                    window.dispatchEvent(new Event('pdfjs-ready'));
                    // 這裡可以添加其他需要在 PDF.js 載入後執行的程式碼
                } else {
                    console.error('❌ PDF.js 初始化失敗：pdfjsLib 未定義');
                }
            }
            function initializeWithoutPDF() {
                console.log('⚠️ 在沒有 PDF.js 的情況下初始化頁面');
                window.pdfJsDisabled = true;
                window.pdfJsReady = false;
                
                // 更新預載狀態顯示
                setTimeout(function() {
                    var statusEn = document.getElementById('status-en');
                    var statusA = document.getElementById('status-a');
                    var statusB = document.getElementById('status-b');
                    
                    if (statusEn) statusEn.textContent = 'PDF功能已禁用';
                    if (statusA) statusA.textContent = 'PDF功能已禁用';
                    if (statusB) statusB.textContent = 'PDF功能已禁用';
                    
                    // 顯示警告訊息給用戶
                    var warningDiv = document.createElement('div');
                    warningDiv.style.cssText = 'background:#fff3cd;border:1px solid #ffeaa7;color:#856404;padding:10px;margin:10px;border-radius:5px;';
                    warningDiv.innerHTML = '⚠️ PDF 功能暫時無法使用，但您仍可以使用其他分析功能。請檢查網路連接或稍後重試。';
                    document.body.insertBefore(warningDiv, document.body.firstChild);
                }, 1000);
            }
            function trySetLocalWorker() {
                fetch('assets/pdfjs/pdf.worker.min.js', { method: 'HEAD' })
                    .then(r => {
                        if (r.ok) {
                            console.log('✅ 使用本地 PDF Worker');
                            setWorker('assets/pdfjs/pdf.worker.min.js');
                        } else {
                            console.log('⚠️ 本地 PDF Worker 不存在，使用 Mozilla CDN');
                            setWorker('https://mozilla.github.io/pdf.js/build/pdf.worker.min.js');
                        }
                    })
                    .catch(() => {
                        console.log('⚠️ 無法檢查本地 PDF Worker，使用 Mozilla CDN');
                        setWorker('https://mozilla.github.io/pdf.js/build/pdf.worker.min.js');
                    });
            }
            function loadPdfJS() {
                var s = document.createElement('script');
                s.src = 'assets/pdfjs/pdf.min.js';
                s.onload = function() {
                    console.log('✅ 本地 PDF.js 載入成功');
                    trySetLocalWorker();
                    initializePdfJS();
                };
                s.onerror = function() {
                    console.log('⚠️ 本地 PDF.js 不存在，使用 Mozilla 官方 CDN');
                    var s2 = document.createElement('script');
                    // 使用 Mozilla 官方 CDN，最可靠
                    s2.src = 'https://mozilla.github.io/pdf.js/build/pdf.min.js';
                    s2.onload = function() {
                        console.log('✅ Mozilla CDN PDF.js 載入成功');
                        setWorker('https://mozilla.github.io/pdf.js/build/pdf.worker.min.js');
                        initializePdfJS();
                    };
                    s2.onerror = function() {
                        console.error('❌ Mozilla CDN 失敗，嘗試 jsDelivr CDN');
                        // 嘗試 jsDelivr CDN
                        var s3 = document.createElement('script');
                        s3.src = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.min.js';
                        s3.onload = function() {
                            console.log('✅ jsDelivr CDN PDF.js 載入成功');
                            setWorker('https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.worker.min.js');
                            initializePdfJS();
                        };
                        s3.onerror = function() {
                            console.error('❌ 所有 PDF.js CDN 都載入失敗，禁用 PDF 功能');
                            // 禁用 PDF 功能，但不阻止頁面其他功能
                            window.pdfJsDisabled = true;
                            initializeWithoutPDF();
                        };
                        // 添加超時保護，防止載入卡住
                        setTimeout(function() {
                            if (!window.pdfJsReady && !window.pdfJsDisabled) {
                                console.error('❌ PDF.js 載入超時，禁用 PDF 功能');
                                window.pdfJsDisabled = true;
                                initializeWithoutPDF();
                            }
                        }, 10000); // 10秒超時
                        document.head.appendChild(s3);
                    };
                    document.head.appendChild(s2);
                };
                document.head.appendChild(s);
            }
            loadPdfJS();
        })();
    </script>
    <script src="ifrs_s1_complete_articles.js"></script>
    <style>
/* Toggle Switch Styles */
.switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
}

.slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .4s;
}

input:checked + .slider {
    background-color: #2196F3;
}

input:focus + .slider {
    box-shadow: 0 0 1px #2196F3;
}

input:checked + .slider:before {
    transform: translateX(26px);
}

.slider.round {
    border-radius: 24px;
}

.slider.round:before {
    border-radius: 50%;
}

.setting-group {
    margin-bottom: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #2196F3;
}

/* 導出控制面板樣式 */
.export-controls {
    margin-bottom: 30px;
    padding: 20px;
    background: #f0f8ff;
    border-radius: 12px;
    border: 2px solid #4285f4;
    box-shadow: 0 4px 12px rgba(66, 133, 244, 0.1);
    position: relative;
    z-index: 10;
}

.export-options {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 20px;
    align-items: start;
}

.export-info p {
    margin: 8px 0;
    font-size: 14px;
    color: #555;
}

.export-info span {
    font-weight: 600;
    color: #2196F3;
}

.export-buttons {
    display: flex;
    justify-content: center;
    align-items: center;
}

.export-buttons .btn-ai-special {
    grid-column: 1 / -1;
    background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 100%);
    font-weight: 600;
    position: relative;
    overflow: hidden;
}

.export-buttons .btn-ai-special::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}

.export-buttons .btn-ai-special:hover::before {
    left: 100%;
}

.btn-export {
    padding: 12px 16px;
    background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: left;
    box-shadow: 0 2px 8px rgba(66, 133, 244, 0.2);
    position: relative;
    z-index: 20;
    pointer-events: auto;
}

.btn-export:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(66, 133, 244, 0.3);
}

.btn-export:active {
    transform: translateY(0);
}

@media (max-width: 768px) {
    .export-options {
        grid-template-columns: 1fr;
    }
    
    .export-buttons {
        grid-template-columns: 1fr;
    }
}

/* IFRS S1 建議書預覽模態窗口 */
.recommendation-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.8);
    backdrop-filter: blur(5px);
}

.recommendation-content {
    position: relative;
    background-color: #fefefe;
    margin: 2% auto;
    padding: 0;
    border: none;
    width: 95%;
    max-width: 1200px;
    height: 90vh;
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    display: flex;
    flex-direction: column;
}

.recommendation-header {
    padding: 20px 30px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px 12px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.recommendation-header h2 {
    margin: 0;
    font-size: 1.5em;
    font-weight: 600;
}

.recommendation-close {
    background: none;
    border: none;
    color: white;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    padding: 0;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.3s;
}

.recommendation-close:hover {
    background-color: rgba(255,255,255,0.2);
}

.recommendation-toolbar {
    padding: 15px 30px;
    background: #f8f9ff;
    border-bottom: 1px solid #e1e5e9;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 10px;
}

.recommendation-actions {
    display: flex;
    gap: 10px;
}

.recommendation-btn {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 8px;
}

.recommendation-btn.primary {
    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    color: white;
}

.recommendation-btn.secondary {
    background: #f1f3f4;
    color: #5f6368;
    border: 1px solid #dadce0;
}

.recommendation-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.recommendation-body {
    flex: 1;
    overflow-y: auto;
    padding: 30px;
    background: white;
}

.recommendation-document {
    max-width: 800px;
    margin: 0 auto;
    line-height: 1.8;
    color: #333;
    font-family: 'Microsoft JhengHei', 'Times New Roman', serif;
}

.recommendation-document h1 {
    text-align: center;
    color: #1a73e8;
    border-bottom: 3px solid #1a73e8;
    padding-bottom: 20px;
    margin-bottom: 30px;
    font-size: 2.2em;
}

.recommendation-document h2 {
    color: #34a853;
    margin-top: 40px;
    margin-bottom: 20px;
    font-size: 1.4em;
    border-left: 4px solid #34a853;
    padding-left: 15px;
}

.recommendation-document h3 {
    color: #ea4335;
    margin-top: 25px;
    margin-bottom: 15px;
    font-size: 1.2em;
}

.recommendation-document p {
    margin-bottom: 15px;
    text-align: justify;
}

.recommendation-document ul, .recommendation-document ol {
    margin-bottom: 20px;
    padding-left: 25px;
}

.recommendation-document li {
    margin-bottom: 8px;
}

.recommendation-highlight {
    background: linear-gradient(120deg, #a8e6cf 0%, #dcedc8 100%);
    padding: 20px;
    border-radius: 8px;
    border-left: 4px solid #4CAF50;
    margin: 20px 0;
}

.recommendation-evidence {
    background: #f8f9ff;
    border: 1px solid #e8eaed;
    border-radius: 8px;
    padding: 15px;
    margin: 15px 0;
}

.recommendation-evidence-title {
    font-weight: 600;
    color: #1a73e8;
    margin-bottom: 10px;
}

.loading-ai {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 300px;
    color: #666;
}

.loading-ai .spinner-ai {
    width: 50px;
    height: 50px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #4285f4;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@media (max-width: 768px) {
    .recommendation-content {
        width: 98%;
        height: 95vh;
        margin: 1% auto;
    }
    
    .recommendation-body {
        padding: 20px;
    }
    
    .recommendation-toolbar {
        flex-direction: column;
        align-items: stretch;
    }
    
    .recommendation-actions {
        justify-content: center;
    }
}        /* 確保 PDF 文本層使用正確的字體 */
        .textLayer {
            font-family: 'Microsoft JhengHei', 'PingFang TC', 'Microsoft YaHei', 'Heiti TC', 'LiHei Pro', sans-serif !important;
        }
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Google Sans', 'Microsoft JhengHei', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f0fe 100%);
            min-height: 100vh;
            color: #202124;
            line-height: 1.6;
        }
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }
        .hero-section {
            text-align: center;
            padding: 60px 24px 40px;
            margin-bottom: 40px;
        }
        .hero-title {
            font-size: 3.2rem;
            font-weight: 400;
            color: #1a73e8;
            margin: 0 0 16px;
            letter-spacing: -0.02em;
        }
        .hero-subtitle {
            font-size: 1.25rem;
            color: #5f6368;
            margin: 0 0 40px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            font-weight: 300;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 2px 10px rgba(60, 64, 67, 0.15);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(218, 220, 224, 0.5);
        }
        .card:hover {
            box-shadow: 0 8px 25px rgba(60, 64, 67, 0.2);
            transform: translateY(-2px);
        }
        .card-title {
            font-size: 1.5rem;
            font-weight: 500;
            color: #202124;
            margin: 0 0 16px;
        }
        .upload-zone {
            border: 2px dashed #dadce0;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .upload-zone:hover, .upload-zone.dragover {
            border-color: #4285f4;
            background: rgba(66, 133, 244, 0.04);
        }
        .upload-icon {
            font-size: 3rem;
            color: #9aa0a6;
            margin-bottom: 16px;
        }
        .upload-text {
            color: #5f6368;
            font-size: 1.1rem;
        }
        .file-input {
            display: none;
        }
        .btn {
            border: none;
            padding: 12px 24px;
            border-radius: 24px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: 500;
        }
        .btn-primary {
            background: #1a73e8;
            color: white;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e0e0e0;
            border-top: 4px solid #4285f4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .progress-bar {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 4px;
            margin-top: 10px;
        }
        .progress-bar-inner {
            height: 8px;
            width: 0%;
            background-color: #4285f4;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .report-container, .preloaded-docs-container {
            margin-top: 24px;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            min-height: 50px;
            position: relative;
            z-index: 1;
        }
        .result-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 10px rgba(60, 64, 67, 0.1);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin: 20px 0;
        }
        .stat-item {
            text-align: center;
        }
        .stat-number {
            font-size: 1.8rem;
            font-weight: 500;
            color: #1a73e8;
        }
        .stat-label {
            color: #5f6368;
            font-size: 0.9rem;
        }

        /* Multi-stage progress bar styles */
        .progress-stage {
            margin-bottom: 15px;
        }
        .progress-stage-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .progress-stage-status {
            font-size: 0.9em;
            color: #5f6368;
        }
        .progress-stage.active .progress-stage-status {
            color: #1a73e8;
            font-weight: 600;
        }
        .progress-stage.completed .progress-stage-status {
            color: #137333;
            font-weight: 600;
        }
        .keyword-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .keyword-tag {
            background: #e8f0fe;
            color: #1a73e8;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 0.9rem;
        }
        /* Evidence cards and scrolling list */
        .article-card {
            border-left: 4px solid #1a73e8;
        }
        .article-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }
        .article-meta {
            color: #5f6368;
            font-size: 0.9rem;
        }
        .evidence-list {
            max-height: 260px;
            overflow-y: auto;
            padding-right: 6px;
            border-top: 1px dashed #e0e0e0;
            margin-top: 12px;
        }
        .evidence-item {
            padding: 12px 0;
            border-bottom: 1px solid #f1f3f4;
        }
        .evidence-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }
        .badge {
            display: inline-block;
            padding: 2px 8px;
            font-size: 0.8rem;
            border-radius: 10px;
            background: #e8f0fe;
            color: #1a73e8;
        }
        .evidence-content {
            color: #202124;
        }
        .evidence-reasoning {
            margin-top: 6px;
            font-size: 0.9rem;
            color: #5f6368;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 8px;
        }

        /* 模型選擇面板樣式 */
        .model-selection-panel {
            margin-bottom: 24px;
        }
        
        .model-description {
            color: #5f6368;
            font-size: 1rem;
            margin: 8px 0 24px;
            text-align: center;
        }
        
        .model-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .model-option {
            position: relative;
        }
        
        .model-option input[type="radio"] {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }
        
        .model-card {
            display: block;
            padding: 20px;
            border: 2px solid #e8eaed;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fafbfc;
            height: 100%;
            box-sizing: border-box;
        }
        
        .model-card:hover {
            border-color: #4285f4;
            background: rgba(66, 133, 244, 0.04);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(60, 64, 67, 0.15);
        }
        
        .model-option.selected .model-card {
            border-color: #1a73e8;
            background: rgba(26, 115, 232, 0.08);
            box-shadow: 0 2px 8px rgba(26, 115, 232, 0.2);
        }
        
        .model-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .model-icon {
            font-size: 2rem;
            margin-right: 12px;
            min-width: 40px;
        }
        
        .model-info h4 {
            margin: 0 0 4px;
            font-size: 1.2rem;
            font-weight: 600;
            color: #202124;
        }
        
        .model-info p {
            margin: 0;
            font-size: 0.9rem;
            color: #5f6368;
        }
        
        .model-specs {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        
        .model-specs .spec {
            background: #e8f0fe;
            color: #1967d2;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .model-option.selected .model-specs .spec {
            background: #1a73e8;
            color: white;
        }
        
        .model-features {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .model-features .feature {
            background: #f1f3f4;
            color: #3c4043;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }
        
        .model-option.selected .model-features .feature {
            background: rgba(26, 115, 232, 0.1);
            color: #1a73e8;
        }
        
        .model-status {
            text-align: center;
            padding: 12px 20px;
            background: rgba(52, 168, 83, 0.1);
            border-radius: 24px;
            border: 1px solid rgba(52, 168, 83, 0.2);
        }
        
        .status-indicator {
            font-size: 1.2rem;
            margin-right: 8px;
        }
        
        .status-text {
            font-weight: 500;
            color: #137333;
        }
        
        @media (max-width: 768px) {
            .model-options {
                grid-template-columns: 1fr;
            }
            
            .model-card {
                padding: 16px;
            }
            
            .model-header {
                margin-bottom: 12px;
            }
            
            .model-icon {
                font-size: 1.5rem;
                margin-right: 8px;
                min-width: 32px;
            }
            
            .model-info h4 {
                font-size: 1.1rem;
            }
            
            .model-info p {
                font-size: 0.85rem;
            }
        }

        /* 技術架構簡介樣式 */
        .tech-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-top: 20px;
        }

        .tech-item {
            display: flex;
            gap: 16px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f0fe 100%);
            border-radius: 12px;
            border: 1px solid rgba(26, 115, 232, 0.1);
            transition: all 0.3s ease;
        }

        .tech-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(26, 115, 232, 0.15);
            border-color: rgba(26, 115, 232, 0.2);
        }

        .tech-icon {
            font-size: 2rem;
            flex-shrink: 0;
            display: flex;
            align-items: flex-start;
            margin-top: 4px;
        }

        .tech-content {
            flex: 1;
        }

        .tech-content h4 {
            margin: 0 0 8px 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #1a73e8;
        }

        .tech-content p {
            margin: 0;
            font-size: 0.9rem;
            line-height: 1.5;
            color: #3c4043;
        }

        @media (max-width: 768px) {
            .tech-overview {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .tech-item {
                padding: 16px;
            }
            
            .tech-icon {
                font-size: 1.5rem;
            }
        }

        /* PDF導出按鈕樣式 */
        .btn-pdf-primary {
            background: linear-gradient(135deg, #d32f2f 0%, #f44336 100%) !important;
            color: white !important;
            font-size: 1.1rem !important;
            padding: 16px 32px !important;
            border-radius: 8px !important;
            box-shadow: 0 4px 15px rgba(211, 47, 47, 0.3) !important;
            transition: all 0.3s ease !important;
            border: none !important;
            font-weight: 600 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 8px !important;
            width: 100% !important;
            margin: 0 auto !important;
        }

        .btn-pdf-primary:hover {
            background: linear-gradient(135deg, #c62828 0%, #e53935 100%) !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 20px rgba(211, 47, 47, 0.4) !important;
        }

        /* HTML預覽按鈕樣式 */
        .btn-html-preview {
            background: linear-gradient(135deg, #1976d2 0%, #2196f3 100%) !important;
            color: white !important;
            font-size: 1.1rem !important;
            padding: 16px 32px !important;
            border-radius: 8px !important;
            border: none !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            font-weight: 600 !important;
            text-transform: none !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 8px !important;
            width: 100% !important;
            margin: 0 auto !important;
        }

        .btn-html-preview:hover {
            background: linear-gradient(135deg, #1565c0 0%, #1e88e5 100%) !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 20px rgba(25, 118, 210, 0.4) !important;
        }

        .export-buttons {
            display: flex !important;
            justify-content: center !important;
            padding: 20px 0 !important;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="hero-section">
            <h1 class="hero-title">ESG報告書轉換IFRS S1條文自動配對工具</h1>
            <p class="hero-subtitle">上傳您的永續報告書PDF文件，系統將自動與IFRS S1條文進行比對，並生成分析報告。</p>
            

        </div>


        <!-- 技術架構簡介 -->
        <div class="card">
            <h2 class="card-title"> 技術架構簡介</h2>
            <div class="tech-overview">
                <div class="tech-item">
                    <div class="tech-icon"></div>
                    <div class="tech-content">
                        <h4>雙模型融合架構</h4>
                        <p>結合 EmbeddingGemma (Google) 和 Qwen3-Embedding (阿里巴巴) 兩個先進嵌入模型，透過加權平均融合 (Gemma 60% + Qwen3 40%) 產生896維融合向量，提供更準確的語義理解。</p>
                    </div>
                </div>
                <div class="tech-item">
                    <div class="tech-icon"></div>
                    <div class="tech-content">
                        <h4>FAISS 加速檢索</h4>
                        <p>採用 Facebook AI Similarity Search 向量索引技術，預先建立125條 IFRS S1 條文的向量索引，結合 BM25 關鍵詞搜索 (30%) 和語義向量搜索 (70%) 的混合檢索架構，大幅提升分析速度。</p>
                    </div>
                </div>
                <div class="tech-item">
                    <div class="tech-icon"></div>
                    <div class="tech-content">
                        <h4>語義映射系統</h4>
                        <p>內建詞彙語義映射字典，智慧轉換 IFRS 正式術語與 ESG 報告書用詞，支援條文特定分析與證據去重，確保每個條文找到獨特且相關的證據內容。</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2 class="card-title">上傳文件</h2>
            <div class="upload-zone">
                <input type="file" id="fileInput" class="file-input" accept=".pdf">
                <div class="upload-icon"></div>
                <p class="upload-text">點擊或拖拽PDF文件到這裡</p>
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">選擇文件</button>
            </div>
        </div>

        <div class="loading" id="loadingIndicator">
            <div class="card" style="padding: 24px;">
                <h3 style="text-align: center; margin-bottom: 20px; color: #1a73e8;">正在進行深度分析...</h3>
                <div id="multi-stage-progress">
                    <div class="progress-stage" id="stage-pdf">
                        <div class="progress-stage-header">
                            <span>1. PDF 文件解析</span>
                            <span class="progress-stage-status">待處理</span>
                        </div>
                        <div class="progress-bar"><div class="progress-bar-inner"></div></div>
                    </div>
                    <div class="progress-stage" id="stage-analysis">
                        <div class="progress-stage-header">
                            <span>2. 條文語義分析</span>
                            <span class="progress-stage-status">待處理</span>
                        </div>
                        <div class="progress-bar"><div class="progress-bar-inner"></div></div>
                    </div>
                    <div class="progress-stage" id="stage-report">
                        <div class="progress-stage-header">
                            <span>3. 產生分析報告</span>
                            <span class="progress-stage-status">待處理</span>
                        </div>
                        <div class="progress-bar"><div class="progress-bar-inner"></div></div>
                    </div>
                </div>
                <div id="overall-status" style="text-align: center; margin-top: 20px; font-weight: 500; color: #5f6368;">正在初始化...</div>
            </div>
        </div>

        <!-- 報告導出控制面板 -->
        <div class="export-controls card" id="exportControls" style="display:none;">
            <h3>分析報告導出</h3>
            <div class="export-options">
                <div class="export-info">
                    <p><strong>文件名稱：</strong><span id="exportFileName">-</span></p>
                    <p><strong>分析所花時間：</strong><span id="exportAnalysisDate">-</span></p>
                    <p><strong>匹配條文：</strong><span id="exportMatchCount">-</span></p>
                </div>
                <div class="export-buttons">
                    <button class="btn btn-export btn-pdf-primary" onclick="downloadReportAsHTML()">
                        💾 下載HTML報告
                    </button>
                </div>
            </div>
        </div>

        <div class="report-container" id="reportContainer"></div>

        <!-- IFRS S1 建議書預覽模態窗口 -->
        <div id="recommendationModal" class="recommendation-modal">
            <div class="recommendation-content">
                <div class="recommendation-header">
                    <h2> IFRS S1 建議書報告 (AI生成)</h2>
                    <button class="recommendation-close" onclick="closeRecommendationModal()">&times;</button>
                </div>
                
                <div class="recommendation-toolbar">
                    <div class="recommendation-info">
                        <span id="recommendationStatus">準備生成建議書...</span>
                    </div>
                    <div class="recommendation-actions">
                        <button class="recommendation-btn secondary" onclick="regenerateRecommendation()">
                             重新生成
                        </button>
                        <button class="recommendation-btn primary" onclick="downloadRecommendationReport()">
                             下載建議書
                        </button>
                        <button class="recommendation-btn secondary" onclick="printRecommendationReport()">
                             列印
                        </button>
                    </div>
                </div>
                
                <div class="recommendation-body">
                    <div id="recommendationContent">
                        <div class="loading-ai">
                            <div class="spinner-ai"></div>
                            <p> AI正在分析您的報告並生成IFRS S1建議書...</p>
                            <p style="font-size: 0.9em; color: #888;">這可能需要30-60秒，請耐心等候</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="preloaded-docs-container card">
            <h3>預載IFRS文件狀態</h3>
            <div id="preloaded-docs-status">
                <p><strong>IFRS S1 (EN):</strong> <span id="status-en">Loading...</span></p>
                <p><strong>IFRS S1 (A):</strong> <span id="status-a">Loading...</span></p>
                <p><strong>IFRS S1 (B):</strong> <span id="status-b">Loading...</span></p>
                <p><strong>Semantic Service:</strong> <span id="status-semantic">Checking...</span></p>
            </div>
        </div>
    </div>

    <script>
        // Apply console overrides immediately before any other code runs
        (function() {
            // Store original console methods
            const originalWarn = console.warn;
            const originalLog = console.log;
            const originalError = console.error;

            // Override console methods globally to suppress PDF.js warnings
            console.warn = function(...args) {
                // Suppress all PDF.js font-related warnings
                const message = args.join(' ');
                if (message.includes('loadFont') || message.includes('translateFont') ||
                    message.includes('CMap') || message.includes('font face') ||
                    message.includes('TT: undefined function') ||
                    message.includes('baseUrl') || message.includes('cMapUrl') ||
                    (message.includes('Warning:') && message.includes('loadFont'))) {
                    return; // Suppress the warning completely
                }
                originalWarn.apply(console, args);
            };

            console.log = function(...args) {
                // Suppress PDF.js worker messages and font warnings
                const message = args.join(' ');
                if (message.includes('loadFont') || message.includes('translateFont') ||
                    message.includes('CMap') || message.includes('font face') ||
                    message.includes('TT: undefined function') ||
                    message.includes('baseUrl') || message.includes('cMapUrl') ||
                    (message.includes('Warning:') && message.includes('loadFont'))) {
                    return; // Suppress the warning completely
                }
                originalLog.apply(console, args);
            };

            console.error = function(...args) {
                // Suppress PDF.js font-related errors but keep other errors
                const message = args.join(' ');
                if (message.includes('loadFont') || message.includes('translateFont') ||
                    message.includes('CMap') || message.includes('font face') ||
                    message.includes('TT: undefined function') ||
                    message.includes('baseUrl') || message.includes('cMapUrl')) {
                    return; // Suppress PDF.js font errors
                }
                originalError.apply(console, args);
            };

            // Override window.console as well to catch everything
            if (window.console) {
                window.console.warn = console.warn;
                window.console.log = console.log;
                window.console.error = console.error;
            }
        })();
        document.addEventListener('DOMContentLoaded', () => {
            // --- Global State and Configuration ---
            const ifrs1Data = { articles: [] };
            const ifrs1EnData = {
                articles: [
                    // 移除 IFRS-S1-1 到 IFRS-S1-19，這些條文已不再使用配對功能，系統從 IFRS-S1-21 開始
                ]
            };
            let preloadedPDFFiles = {};
            let analysisReportData = {};
            let sentencesByPage = [];
            let paragraphsByPage = [];

            //  PDF文字緩存管理器
            class PDFTextCache {
                constructor() {
                    this.cache = new Map();
                    this.maxCacheSize = 50; // 最多緩存50個文件
                    this.cacheKey = 'ifrs_pdf_text_cache_v1';
                    this.loadCacheFromStorage();
                }

                generateFileHash(file) {
                    // 使用文件名、大小、修改時間生成哈希
                    const hashSource = `${file.name}_${file.size}_${file.lastModified}`;
                    // 使用encodeURIComponent確保字符串安全，然後生成哈希
                    try {
                        return btoa(encodeURIComponent(hashSource)).replace(/[+/=]/g, '').substring(0, 16);
                    } catch (e) {
                        // 降級方案：使用簡單字符串哈希
                        let hash = 0;
                        for (let i = 0; i < hashSource.length; i++) {
                            const char = hashSource.charCodeAt(i);
                            hash = ((hash << 5) - hash) + char;
                            hash = hash & hash; // 轉換為32位整數
                        }
                        return Math.abs(hash).toString(36).substring(0, 16);
                    }
                }

                loadCacheFromStorage() {
                    try {
                        const stored = localStorage.getItem(this.cacheKey);
                        if (stored) {
                            const parsed = JSON.parse(stored);
                            Object.entries(parsed).forEach(([key, value]) => {
                                this.cache.set(key, {
                                    ...value,
                                    timestamp: new Date(value.timestamp)
                                });
                            });
                            console.log(` 從本地加載了 ${this.cache.size} 個PDF緩存`);
                        }
                    } catch (error) {
                        console.warn('PDF緩存加載失敗:', error);
                        this.cache.clear();
                    }
                }

                saveCacheToStorage() {
                    try {
                        const cacheObj = {};
                        this.cache.forEach((value, key) => {
                            cacheObj[key] = {
                                ...value,
                                timestamp: value.timestamp.toISOString()
                            };
                        });
                        localStorage.setItem(this.cacheKey, JSON.stringify(cacheObj));
                    } catch (error) {
                        console.warn('PDF緩存保存失敗:', error);
                    }
                }

                getCachedText(file) {
                    const hash = this.generateFileHash(file);
                    const cached = this.cache.get(hash);
                    
                    if (cached) {
                        // 檢查緩存是否過期 (7天)
                        const daysSinceCached = (Date.now() - cached.timestamp) / (1000 * 60 * 60 * 24);
                        if (daysSinceCached < 7) {
                            console.log(` 使用PDF緩存: ${file.name} (${daysSinceCached.toFixed(1)}天前)`);
                            return cached;
                        } else {
                            console.log(` PDF緩存過期，删除: ${file.name}`);
                            this.cache.delete(hash);
                            this.saveCacheToStorage();
                        }
                    }
                    return null;
                }

                setCachedText(file, textData) {
                    if (this.cache.size >= this.maxCacheSize) {
                        const oldestKey = this.cache.keys().next().value;
                        this.cache.delete(oldestKey);
                        console.log(' 緩存已滿，刪除最舊條目');
                    }
                    const hash = this.generateFileHash(file);
                    const cacheEntry = {
                        timestamp: Date.now(),
                        data: textData
                    };
                    this.cache.set(hash, cacheEntry);
                    this.saveCacheToStorage();
                    console.log(` 已緩存PDF文字: ${file.name}`);
                }

                clearExpiredCache() {
                    const now = Date.now();
                    const expiredKeys = [];
                    
                    this.cache.forEach((value, key) => {
                        const daysSinceCached = (now - value.timestamp) / (1000 * 60 * 60 * 24);
                        if (daysSinceCached >= 7) {
                            expiredKeys.push(key);
                        }
                    });

                    expiredKeys.forEach(key => this.cache.delete(key));
                    if (expiredKeys.length > 0) {
                        this.saveCacheToStorage();
                        console.log(` 清理了 ${expiredKeys.length} 個過期PDF緩存`);
                    }
                }

                getCacheStats() {
                    const totalSize = Array.from(this.cache.values())
                        .reduce((sum, entry) => sum + (entry.fileSize || 0), 0);
                    return {
                        count: this.cache.size,
                        totalSize: Math.round(totalSize / 1024), // KB
                        oldestCached: this.cache.size > 0 ? 
                            Math.min(...Array.from(this.cache.values()).map(e => e.timestamp)) : null
                    };
                }
            }

            // 初始化PDF緩存管理器
            const pdfTextCache = new PDFTextCache();

            // Optional: transformer configuration loaded from localStorage
            const transformerConfig = {
                enabled: (localStorage.getItem('transformer_enabled') === 'true') || false,
                apiKey: localStorage.getItem('transformer_api_key') || '',
                provider: 'openai'
            };

            const PDF_PATHS = {
                en: './IFRS S1 EN.pdf',
                a: './IFRSS1_2023_A.pdf', 
                b: './IFRSS1_2023_B.pdf'
            };

            // Apply PDF.js configuration once it's ready
            function applyPdfJsConfiguration() {
                if (typeof window.pdfjsLib === 'undefined') {
                    console.warn('PDF.js 尚未載入，延後套用設定');
                    return;
                }
                try {
                    const g = window.pdfjsLib.GlobalWorkerOptions;
                    if (!g.workerSrc || g.workerSrc === '') {
                        g.workerSrc = window.pdfWorkerSrcOverride || 'assets/pdfjs/pdf.worker.min.js';
                    }
                    g.disableFontFace = false;

                    // PDF document initialization parameters with Chinese support
                    window.pdfDocInitParams = {
                        // Enable CMap for Chinese character mapping
                        cMapUrl: './cmaps/',
                        cMapPacked: true,
                        
                        // Font and text rendering settings
                        useSystemFonts: true,
                        disableFontFace: false,
                        disableCreateObjectURL: false,
                        fontExtraProperties: true,
                        // Use local standard fonts to avoid remote fetch latency
                        standardFontDataUrl: './standard_fonts/',
                        
                        // Text layer options
                        isEvalSupported: false,
                        maxImageSize: -1,
                        useWorkerFetch: false,
                        stopAtErrors: false,
                        // Rendering optimizations
                        disableAutoFetch: true,
                        disableRange: true,
                        disableStream: true,
                        
                        // Set default font for Chinese characters
                        defaultFontFamily: 'Microsoft JhengHei, Microsoft YaHei, SimHei, SimSun, sans-serif',
                        
                        // Processing mode settings
                        verbosity: 0,
                        ignoreErrors: true,
                        
                        // Canvas rendering settings
                        useOnlyCssZoom: false,
                        maxCanvasPixels: 16777216
                    };
                    
                    // Monkey patch getDocument to inject init params
                    if (!window._originalPdfGetDocument && window.pdfjsLib.getDocument) {
                        window._originalPdfGetDocument = window.pdfjsLib.getDocument;
                        window.pdfjsLib.getDocument = function (src) {
                            const params = typeof src === 'string' ? { url: src } : { ...src };
                            return window._originalPdfGetDocument.call(this, { ...(window.pdfDocInitParams || {}), ...params });
                        };
                    }
                    console.log('✅ 已套用 PDF.js 進階設定');
                } catch (e) {
                    console.error('❌ 套用 PDF.js 設定失敗:', e);
                }
            }

            // 若已就緒則立即套用，否則等待事件
            if (window.pdfJsReady) {
                applyPdfJsConfiguration();
            }
            window.addEventListener('pdfjs-ready', applyPdfJsConfiguration);

            // Helper: wait until PDF.js is ready or disabled
            function waitForPdfJsReady(timeoutMs = 12000) {
                return new Promise((resolve, reject) => {
                    if (window.pdfJsDisabled) return resolve('disabled');
                    if (window.pdfjsLib && window.pdfJsReady) return resolve('ready');
                    const onReady = () => {
                        window.removeEventListener('pdfjs-ready', onReady);
                        resolve('ready');
                    };
                    window.addEventListener('pdfjs-ready', onReady);
                    const id = setTimeout(() => {
                        window.removeEventListener('pdfjs-ready', onReady);
                        reject(new Error('Timed out waiting for PDF.js'));
                    }, timeoutMs);
                });
            }

            // --- UI Element References ---
            const fileInput = document.getElementById('fileInput');
            const uploadZone = document.querySelector('.upload-zone');
            const loadingIndicator = document.getElementById('loadingIndicator');
            let statusElement = document.getElementById('status') || document.getElementById('preload-status');
            // 如果狀態元素不存在，動態創建一個，避免空引用
            if (!statusElement && loadingIndicator) {
                const created = document.createElement('div');
                created.id = 'status';
                created.style.marginTop = '10px';
                created.textContent = '';
                loadingIndicator.appendChild(created);
                statusElement = created;
            }
            // 設置全局變量以便下載函數使用
            window.statusElement = statusElement;

            // --- Multi-stage Progress Bar Logic ---
            const progressStages = {
                pdf: { bar: document.querySelector('#stage-pdf .progress-bar-inner'), status: document.querySelector('#stage-pdf .progress-stage-status'), el: document.getElementById('stage-pdf') },
                analysis: { bar: document.querySelector('#stage-analysis .progress-bar-inner'), status: document.querySelector('#stage-analysis .progress-stage-status'), el: document.getElementById('stage-analysis') },
                report: { bar: document.querySelector('#stage-report .progress-bar-inner'), status: document.querySelector('#stage-report .progress-stage-status'), el: document.getElementById('stage-report') }
            };
            const overallStatusEl = document.getElementById('overall-status');

            function updateProgress(stage, percentage, statusText) {
                if (progressStages[stage]) {
                    progressStages[stage].bar.style.width = `${percentage}%`;
                    progressStages[stage].status.textContent = statusText;

                    if (percentage > 0 && percentage < 100) {
                        progressStages[stage].el.classList.add('active');
                        progressStages[stage].el.classList.remove('completed');
                    } else if (percentage === 100) {
                        progressStages[stage].el.classList.remove('active');
                        progressStages[stage].el.classList.add('completed');
                    }
                }
            }

            function resetProgress() {
                Object.values(progressStages).forEach(stage => {
                    stage.bar.style.width = '0%';
                    stage.status.textContent = '待處理';
                    stage.el.classList.remove('active', 'completed');
                });
                overallStatusEl.textContent = '正在初始化...';
            }
            const reportContainer = document.getElementById('reportContainer');

            // --- Initialization ---
            function initializeIFRSData() {
                console.log('[DEBUG] Initializing IFRS S1 data...');
                try {
                    if (typeof IFRS_S1_COMPLETE_ARTICLES !== 'undefined' && Array.isArray(IFRS_S1_COMPLETE_ARTICLES)) {
                        ifrs1Data.articles = IFRS_S1_COMPLETE_ARTICLES;
                        console.log(`[SUCCESS] Loaded ${ifrs1Data.articles.length} articles.`);
                    } else {
                        throw new Error('External IFRS article data not found or invalid.');
                    }
                } catch (error) {
                    console.error('[ERROR] Failed to load IFRS articles:', error.message);
                    alert('無法加載IFRS S1條文數據，部分功能可能無法正常運作。');
                }
            }

            // --- Utility functions for concept-based matching ---
            function normalizeText(t) {
                return (t || '').toLowerCase();
            }

            function tokenize(text) {
                const t = normalizeText(text);
                // Han chars or alphanumerics
                const m = t.match(/[\p{Script=Han}]+|[a-z0-9]+/gu);
                return m || [];
            }

            const STOPWORDS = new Set(['的','和','與','或','及','在','對','為','是','及其','並','等','與其','以及','包括','或是','如果','應','需','可能','因此','本','該','其','公司','企業','the','and','of','to','in','for','on','with','by','as','is','are','be','that','this','an','a','at','from','it','its','or','not','may','should','must','can','could','would','will']);

            function extractCoreConceptTokens(article, maxTokens = 12) {
                const source = [article.title, article.content].filter(Boolean).join(' ');
                const toks = tokenize(source).filter(tok => !STOPWORDS.has(tok) && tok.length > 1);
                const freq = new Map();
                toks.forEach(tok => freq.set(tok, (freq.get(tok) || 0) + 1));
                const sorted = [...freq.entries()].sort((a,b) => b[1]-a[1]).map(([k]) => k);
                // Always include keywords
                const kws = Array.isArray(article.keywords) ? article.keywords.map(k => normalizeText(k)) : [];
                const set = new Set([...(sorted.slice(0, maxTokens)), ...kws.filter(k => k && !STOPWORDS.has(k))]);
                return [...set];
            }

            function jaccard(aArr, bArr) {
                const a = new Set(aArr);
                const b = new Set(bArr);
                let inter = 0;
                a.forEach(x => { if (b.has(x)) inter++; });
                const union = a.size + b.size - inter;
                return union === 0 ? 0 : inter / union;
            }

            function detectLanguage(text) {
                const tokens = tokenize(text);
                const englishTokens = tokens.filter(t => /^[a-zA-Z]+$/.test(t));
                return englishTokens.length / tokens.length > 0.5;
            }

            // 內容過濾機制：排除目次、重複標題、頁碼等無效內容
            function isInvalidContent(sentence) {
                if (!sentence || sentence.length < 10) return true;
                
                // 目次/目錄模式識別
                const tocPatterns = [
                    /^第[一二三四五六七八九十\d]+章\s*[\.\s]*\d*$/,          // 章節目錄
                    /^第[一二三四五六七八九十\d]+節\s*[\.\s]*\d*$/,          // 節目錄
                    /^\d+[\.\s]+[\u4e00-\u9fff\w\s]+[\.\s]*\d+\s*$/,        // 編號+標題+頁碼
                    /^[\u4e00-\u9fff\w\s]+[\.\s]+\d+\s*$/,                  // 標題+頁碼
                    /^[\.\s]*\d+[\.\s]*$/,                                   // 純頁碼
                    /^目\s*次|目\s*錄|內\s*容/,                             // 目次/目錄/內容
                    /^摘\s*要|序\s*言|前\s*言|附\s*錄/                       // 摘要、序言等
                ];
                
                if (tocPatterns.some(pattern => pattern.test(sentence.trim()))) {
                    console.log('過濾目次內容:', sentence.substring(0, 50));
                    return true;
                }
                
                // 重複標題檢測（簡化版：檢測過短的重複性文本）
                if (sentence.length < 20 && /^[\u4e00-\u9fff\w\s]{1,15}$/.test(sentence)) {
                    const words = sentence.split(/\s+/).filter(w => w.length > 1);
                    if (words.length <= 3) {
                        console.log('過濾疑似重複標題:', sentence);
                        return true;
                    }
                }
                
                // 頁眉頁腳模式
                const headerFooterPatterns = [
                    /^第\s*\d+\s*頁/,                                        // 第X頁
                    /頁\s*\d+\s*$/,                                          // 頁X
                    /^\d{4}年\d{1,2}月/,                                     // 日期格式
                    /^版權所有|©|Copyright/i,                                // 版權聲明
                    /^[\-=\s]*$/                                             // 分隔線
                ];
                
                if (headerFooterPatterns.some(pattern => pattern.test(sentence.trim()))) {
                    console.log('過濾頁眉頁腳:', sentence.substring(0, 30));
                    return true;
                }
                
                // 過短或過長的無效內容
                if (sentence.length < 15 || sentence.length > 1000) {
                    return true;
                }
                
                // 數字密度過高（可能是表格數據）
                const numbers = sentence.match(/\d/g) || [];
                if (numbers.length / sentence.length > 0.3) {
                    console.log('過濾數字密度過高:', sentence.substring(0, 50));
                    return true;
                }
                
                return false;
            }

            function scoreSentence(sentence, coreTokens, keywordSet) {
                const toks = tokenize(sentence);
                let coreHit = 0;
                let kwHit = 0;
                const matchedCore = [];
                const sentenceTokens = new Set(toks);

                // Check core concept matches
                for (const coreToken of coreTokens) {
                    if (sentenceTokens.has(coreToken)) {
                        coreHit++;
                        matchedCore.push(coreToken);
                    }
                }

                // Check keyword matches
                for (const token of toks) {
                    if (keywordSet.has(token)) {
                        kwHit++;
                    }
                }

                return { coreHit, kwHit, matchedCore, toks };
            }

            async function generateAIReasoning(article, sentence, page, matchedCore, unmatchedCore, simScore) {
                // 直接使用本地動態生成
                return generateDynamicReasoning(article, sentence, page, matchedCore, unmatchedCore, simScore);
            }
            
            async function generateTransformerReasoning(article, sentence, page, matchedCore, unmatchedCore) {
                if (!transformerConfig.enabled || !transformerConfig.apiKey) return null;
                try {
                    const matchedCoreText = matchedCore.slice(0, 5).join('、');
                    const unmatchedCoreText = unmatchedCore.slice(0, 5).join('、');

                    const prompt = `身為資深企業永續發展顧問，請分析以下內容：

條文：${article.id} ${article.title}
條文內容摘要：${(article.content || '').slice(0, 400)}

候選證據（第${page}頁）：${sentence}

已匹配核心概念：${matchedCoreText || '無'}
未匹配核心概念：${unmatchedCoreText || '無'}

請以專業商業顧問的視角分析：
1. 此證據與條文的核心概念關聯性
2. 共同點：句子與條文在商業邏輯上的對齊程度
3. 差異點：句子相對於條文標準的不足之處
4. 整體評估：此證據的證明力強度

請用繁體中文提供精簡但深入的分析，直接進入分析內容，不要有開場白。`;

                    const body = {
                        model: 'gpt-4o-mini',
                        messages: [
                            { role: 'system', content: '你是資深企業永續發展顧問，專精IFRS S1條文分析與企業實務應用。你需要提供專業、客觀的商業分析見見。' },
                            { role: 'user', content: prompt }
                        ],
                        temperature: 0.3,
                        max_tokens: 300
                    };

                    // Ensure proper UTF-8 encoding for Chinese characters
                    const resp = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json; charset=utf-8',
                            'Authorization': `Bearer ${transformerConfig.apiKey}`
                        },
                        body: JSON.stringify(body)
                    });

                    if (!resp.ok) {
                        throw new Error(`API request failed: ${resp.status}`);
                    }

                    const data = await resp.json();
                    let text = data?.choices?.[0]?.message?.content?.trim();

                    // Ensure proper UTF-8 decoding of Chinese characters
                    if (text) {
                        // Decode any potential encoding issues
                        text = decodeURIComponent(encodeURIComponent(text));
                        // Ensure it's properly encoded for HTML display
                        text = text.replace(/[\u00A0-\u9999<>\&]/g, function(i) {
                            return '&#'+i.charCodeAt(0)+';';
                        }).replace(/&#60;/g, '&lt;').replace(/&#62;/g, '&gt;').replace(/&#38;/g, '&amp;');
                    }

                    return text || null;
                } catch (e) {
                    console.warn('[WARN] Transformer reasoning failed:', e);
                    return null;
                }
            }

            function generateDynamicReasoning(article, sentence, page, matchedCore, unmatchedCore, simScore) {
                // 增強版動態生成證據解釋，利用條文的豐富上下文資訊
                const coreMatches = matchedCore.length;
                const semanticStrength = simScore;
                
                // 獲取條文的擴充資訊
                const articleCategory = article.category || '一般條文';
                const articleDifficulty = article.difficulty || 'medium';
                const practicalGuidance = article.practical_guidance || '';
                const relatedStandards = article.related_standards || [];
                
                // 根據條文類別調整分析角度
                const categoryContext = {
                    '治理': {
                        focus: '治理架構與責任分工',
                        keywords: ['董事會', '管理階層', '委員會', '職責', '監督'],
                        emphasis: '組織層面的永續治理機制'
                    },
                    '策略': {
                        focus: '策略規劃與執行',
                        keywords: ['策略', '目標', '計劃', '資源', '執行'],
                        emphasis: '企業永續策略的制定與實施'
                    },
                    '風險管理': {
                        focus: '風險識別與管控',
                        keywords: ['風險', '識別', '評估', '管控', '緩解'],
                        emphasis: '永續風險的系統性管理'
                    },
                    '指標與目標': {
                        focus: '量化指標與目標設定',
                        keywords: ['指標', '目標', '量化', '監控', '績效'],
                        emphasis: '可量化的永續績效管理'
                    },
                    '報告基礎': {
                        focus: '資訊揭露與報告品質',
                        keywords: ['揭露', '報告', '資訊', '透明', '品質'],
                        emphasis: '永續資訊的有效傳達'
                    }
                };
                
                const currentContext = categoryContext[articleCategory] || categoryContext['報告基礎'];
                
                // 根據條文難度調整評估標準
                let difficultyThresholds = { high: 0.20, medium: 0.12, low: 0.08 };
                if (articleDifficulty === 'high') difficultyThresholds = { high: 0.25, medium: 0.15, low: 0.10 };
                if (articleDifficulty === 'low') difficultyThresholds = { high: 0.15, medium: 0.08, low: 0.05 };
                
                // 動態選擇強度等級（考慮條文難度）
                let strengthLevel = 'low';
                if (coreMatches >= 3 && semanticStrength >= difficultyThresholds.high) strengthLevel = 'high';
                else if (coreMatches >= 2 || semanticStrength >= difficultyThresholds.medium) strengthLevel = 'medium';
                
                // 多樣化的強度描述
                const strengthDescriptors = {
                    high: ['充分體現', '明確反映', '深度契合', '全面涵蓋', '具體落實'],
                    medium: ['部分體現', '適度反映', '基本符合', '局部涵蓋', '初步展現'],
                    low: ['略有提及', '間接涉及', '隱約相關', '有限反映', '零星涉及']
                };
                
                const strengthVerb = strengthDescriptors[strengthLevel][Math.floor(Math.random() * strengthDescriptors[strengthLevel].length)];
                
                // 增強版模板，結合條文類別特性
                const templates = [
                    // 類別導向分析型
                    () => `從${currentContext.focus}的角度分析，此段內容${strengthVerb}了${article.title}在${currentContext.emphasis}方面的要求。文中${matchedCore.slice(0, 2).join('與')}等概念與條文核心${strengthLevel === 'high' ? '高度吻合' : strengthLevel === 'medium' ? '基本對應' : '部分相關'}。`,
                    
                    // 實務指引整合型
                    () => `依據IFRS S1實務指引，該證據在${currentContext.focus}層面${strengthVerb}相關要求。${practicalGuidance ? '特別是在' + practicalGuidance.slice(0, 50) + '等方面，' : ''}語義相似度${(semanticStrength * 100).toFixed(1)}%顯示${strengthLevel === 'high' ? '強力支撐' : strengthLevel === 'medium' ? '適度佐證' : '初步印證'}。`,
                    
                    // 條文關聯型
                    () => `此證據與${article.title}要求的匹配度為${(semanticStrength * 100).toFixed(1)}%。${relatedStandards.length > 0 ? `結合相關條文${relatedStandards.slice(0, 2).join('、')}的要求，` : ''}該內容在${currentContext.emphasis}方面${strengthLevel === 'high' ? '提供了充分的證明' : strengthLevel === 'medium' ? '給出了合理的說明' : '展現了基本的認知'}。`,
                    
                    // 難度調整型  
                    () => `考量${article.title}屬${articleDifficulty === 'high' ? '高' : articleDifficulty === 'medium' ? '中' : '低'}複雜度條文，此證據${strengthVerb}了核心要求。在${matchedCore.slice(0, 2).join('與')}等${currentContext.keywords.filter(k => matchedCore.some(m => m.includes(k))).join('、')}關鍵面向上，${strengthLevel === 'high' ? '達到了預期標準' : strengthLevel === 'medium' ? '符合基本要求' : '展現了初步成效'}。`
                ];
                
                // 隨機選擇模板並執行
                const selectedTemplate = templates[Math.floor(Math.random() * templates.length)];
                return selectedTemplate();
            }

            // Utility: timeout wrapper to avoid hanging promises
            function withTimeout(promise, ms = 15000) {
                return new Promise((resolve, reject) => {
                    const timer = setTimeout(() => {
                        reject(new Error(`Operation timed out after ${ms}ms`));
                    }, ms);
                    promise.then((val) => { clearTimeout(timer); resolve(val); })
                           .catch((err) => { clearTimeout(timer); reject(err); });
                });
            }

            // Utility: fetch with timeout using AbortController
            function fetchWithTimeout(resource, options = {}, timeout = 8000) {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), timeout);
                return fetch(resource, { ...options, signal: controller.signal })
                    .finally(() => clearTimeout(id));
            }

            async function preloadPDFFiles() {
                if (!window.pdfjsLib || !window.pdfJsReady) {
                    console.log(' 略過PDF預載（PDF.js 未就緒或已禁用）');
                    Object.keys(PDF_PATHS).forEach((lang) => {
                        const el = document.getElementById(`status-${lang}`);
                        if (el) el.textContent = window.pdfJsDisabled ? 'PDF功能已禁用' : 'Skipped';
                    });
                    return;
                }
                const pdfPromises = Object.keys(PDF_PATHS).map(async (lang) => {
                    const path = PDF_PATHS[lang];
                    const statusUI = document.getElementById(`status-${lang}`);
                    try {
                        if (statusUI) statusUI.textContent = 'Loading...';
                        // Ensure URL is properly encoded to handle spaces and non-ASCII characters
                        const encodedUrl = encodeURI(path);
                        const loadingTask = pdfjsLib.getDocument({ url: encodedUrl, ...(window.pdfDocInitParams || {}) }).promise;
                        preloadedPDFFiles[lang] = await withTimeout(loadingTask, 20000);
                        if (statusUI) {
                            statusUI.textContent = 'Loaded';
                            statusUI.style.color = 'green';
                        }
                        console.log(`[SUCCESS] Preloaded ${path}`);
                    } catch (err) {
                        if (statusUI) {
                            const isMissing = err && (err.name === 'MissingPDFException' || (typeof err.message === 'string' && err.message.includes('Missing PDF')));
                            statusUI.textContent = isMissing ? 'Not Found' : 'Failed';
                            statusUI.style.color = isMissing ? 'orange' : 'red';
                        }
                        console.error(`[ERROR] Failed to preload ${path}:`, err);
                    }
                });
                await Promise.all(pdfPromises);
                console.log('[INFO] PDF preloading complete.');
            }

            // --- File Handling ---
            // uploadZone.addEventListener('click', () => fileInput.click()); // Removed to prevent double popup
            fileInput.addEventListener('change', (e) => handleFileSelect(e.target.files));
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadZone.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (['dragenter', 'dragover'].includes(eventName)) {
                        uploadZone.classList.add('dragover');
                    } else {
                        uploadZone.classList.remove('dragover');
                    }
                }, false);
            });

            uploadZone.addEventListener('drop', (e) => handleFileSelect(e.dataTransfer.files), false);

            async function handleFileSelect(files) {
                if (files.length > 0) {
                    const file = files[0];
                    if (file.type === 'application/pdf') {
                        handleFileUpload(file);
                    } else {
                        alert('請上傳有效的PDF文件。');
                    }
                }
            }

            async function handleFileUpload(file) {
                console.log(`[INFO] File selected: ${file.name}`);

                // Hide hardware status to show file progress
                const hardwareStatus = document.getElementById('hardware-acceleration-status');
                if (hardwareStatus) {
                    hardwareStatus.style.display = 'none';
                }

                // Validate file size (max 50MB)
                const maxFileSize = 50 * 1024 * 1024; // 50MB
                if (file.size > maxFileSize) {
                    alert('檔案大小超過50MB限制，請選擇較小的PDF文件。');
                    return;
                }

                loadingIndicator.style.display = 'block';
                reportContainer.innerHTML = '';
                resetProgress();
                updateProgress('pdf', 5, '正在讀取文件...');
                overallStatusEl.textContent = '步驟 1/3: 解析 PDF 文件';

                //  檢查PDF文字緩存
                const cachedText = pdfTextCache.getCachedText(file);
                if (cachedText && cachedText.data) {
                    console.log(' 使用PDF文字緩存，跳過提取步驟');
                    const textData = cachedText.data;
                    const fakePdf = { 
                        numPages: textData.pages.length, 
                        getPage: async (i) => ({ 
                            getTextContent: async () => ({ 
                                items: textData.pages[i-1].map(t => ({str: t})) 
                            }) 
                        }) 
                    };
                    performComprehensiveAnalysis(fakePdf, file.name);
                    return;
                }

                // Ensure PDF.js is ready before attempting to parse
                try {
                    const state = await waitForPdfJsReady(12000);
                    if (state === 'disabled') {
                        throw new Error('PDF.js disabled');
                    }
                } catch (e) {
                    console.error('[ERROR] PDF.js not ready:', e);
                    loadingIndicator.style.display = 'none';
                    alert('PDF 功能目前不可用（PDF.js 未載入成功）。請稍後再試或檢查網路。');
                    return;
                }

                const fileReader = new FileReader();
                fileReader.onload = async (event) => {
                    try {
                        const pdfData = new Uint8Array(event.target.result);
                        if (!window.pdfjsLib) {
                            throw new Error('pdfjsLib is not available');
                        }
                        const loadingTask = pdfjsLib.getDocument({ data: pdfData, ...(window.pdfDocInitParams || {}) });
                        const pdf = await loadingTask.promise;
                        console.log('PDF loaded successfully');
                        await performComprehensiveAnalysis(pdf, file.name);
                    } catch (error) {
                        console.error('[ERROR] PDF parsing failed:', error);
                        loadingIndicator.style.display = 'none';
                        let errorMessage = 'PDF文件解析失敗';
                        if (error.name === 'InvalidPDFException') {
                            errorMessage = '這不是有效的PDF文件，請檢查檔案格式。';
                        } else if (error.name === 'PasswordException') {
                            errorMessage = 'PDF文件已加密，請提供未加密的PDF文件。';
                        } else if (error.message.includes('CORS')) {
                            errorMessage = 'PDF文件載入受限，請確保檔案未損壞。';
                        }
                        alert(`${errorMessage}: ${error.message}`);
                    }
                };

                fileReader.onerror = () => {
                    console.error('[ERROR] File reading failed');
                    loadingIndicator.style.display = 'none';
                    alert('檔案讀取失敗，請檢查檔案是否損壞或重新上傳。');
                };

                fileReader.onprogress = (e) => {
                    if (e.lengthComputable) {
                        const percentComplete = (e.loaded / e.total) * 100;
                        updateProgress('pdf', 5 + (percentComplete * 0.1), `正在讀取檔案... ${Math.round(percentComplete)}%`);
                    }
                };

                fileReader.readAsArrayBuffer(file);
            }

            // --- Analysis Pipeline ---
            async function performComprehensiveAnalysis(pdf, fileName) {
                statusElement.textContent = '正在從PDF提取文字...';
                let allText = '';
                const totalPages = pdf.numPages;
                sentencesByPage = [];
                paragraphsByPage = [];

                for (let i = 1; i <= totalPages; i++) {
                    try {
                        const page = await pdf.getPage(i);
                        // Use enhanced text extraction with proper text layer handling
                        const textContent = await page.getTextContent({
                            normalizeWhitespace: true,
                            disableCombineTextItems: false  // Keep text items combined for better Chinese character handling
                        });
                        
                        // Improved text extraction with better Chinese character handling
                        const pageText = (textContent.items || [])
                            .map(item => {
                                // Preserve Chinese punctuation and characters
                                let text = (item.str || '').replace(/[\u200b-\u200f\ufeff]/g, ''); // Remove zero-width spaces
                                // Normalize Chinese punctuations and spaces
                                text = text.replace(/[\s\u3000]+/g, ' ').trim(); // Convert full-width spaces to half-width
                                return text;
                            })
                            .filter(Boolean)
                            .join(' ')
                            .replace(/\s+/g, ' ');
                            
                        allText += pageText + '\n';
                        
                        // Enhanced Chinese text segmentation
                        const sentences = [];
                        // Split by Chinese and English sentence terminators
                        const sentenceRegex = /[^。！？!?\n]+([。！？!?\n]|$)/g;
                        let match;
                        while ((match = sentenceRegex.exec(pageText)) !== null) {
                            const sentence = match[0].trim();
                            if (sentence && !isInvalidContent(sentence)) {
                                sentences.push(sentence);
                            }
                        }
                        
                        // Create paragraphs by grouping sentences (5-8 sentences per paragraph with sliding window)
                        const paragraphs = [];
                        const paragraphSize = Math.min(8, Math.max(5, Math.ceil(sentences.length / 10))); // 動態調整段落大小
                        
                        // 主要段落：5-8句為一段
                        for (let i = 0; i < sentences.length; i += paragraphSize) {
                            const paragraph = sentences.slice(i, i + paragraphSize).join(' ');
                            if (paragraph && paragraph.length > 50) { // 確保段落有足夠內容
                                paragraphs.push(paragraph);
                            }
                        }
                        
                        // 滑動窗口段落：重疊分析確保語義連貫性
                        if (sentences.length > paragraphSize) {
                            const overlapSize = Math.floor(paragraphSize / 2);
                            for (let i = overlapSize; i < sentences.length - paragraphSize; i += paragraphSize) {
                                const overlapParagraph = sentences.slice(i, i + paragraphSize).join(' ');
                                if (overlapParagraph && overlapParagraph.length > 50) {
                                    paragraphs.push(overlapParagraph);
                                }
                            }
                        }
                        sentencesByPage.push({ page: i, sentences });
                        paragraphsByPage.push({ page: i, paragraphs });

                        const progress = 15 + ((i / totalPages) * 85);
                        updateProgress('pdf', progress, `正在解析 ${i} / ${totalPages} 頁`);

                    } catch (pageError) {
                        console.warn(`Could not extract text from page ${i}:`, pageError);
                    }
                }

                if (!allText.trim()) {
                    alert('PDF文字內容為空或無法提取，無法進行分析。');
                    loadingIndicator.style.display = 'none';
                    return;
                }

                //  保存提取的文本到緩存 
                const textData = {
                    totalPages,
                    sentencesByPage,
                    paragraphsByPage,
                    extractedText: allText
                };
                
                // 需要獲取當前文件對象來保存緩存，使用全局變量存儲
                if (window.currentProcessingFile) {
                    pdfTextCache.setCachedText(window.currentProcessingFile, textData);
                }

                updateProgress('pdf', 100, '解析完成');
                overallStatusEl.textContent = '步驟 2/3: 進行語義分析';
                updateProgress('analysis', 5, '準備比對...');

                const isEnglish = detectLanguage(allText);
                await performAIAnalysis(allText, fileName, totalPages, isEnglish);
            }

            // === 本地語義分析模組 ===
            class LocalSemanticAnalyzer {
                constructor() {
                    this.models = null;
                    this.preprocessor = null;
                    this.isInitialized = false;
                }

                async initializeModels() {
                    if (this.isInitialized) return;
                    
                    try {
                        console.log('初始化本地語義分析模型...');
                        
                        // 檢查是否有可用的模型服務
                        const response = await fetchWithTimeout('http://localhost:8002/health', {
                            method: 'GET',
                            cache: 'no-store'
                        }, 6000);
                        
                        if (response.ok) {
                            const healthData = await response.json();
                            console.log(`本地模型服務可用: ${healthData.service_type}`);
                            this.isInitialized = true;
                        } else {
                            throw new Error('Local model service not available');
                        }
                    } catch (error) {
                        console.warn('本地模型服務不可用，將使用離線模式:', error);
                        this.isInitialized = false;
                    }
                }

                // 術語標準化字典
                getTerminologyDict() {
                    return {
                        '氣候變遷': '氣候變化',
                        '氣候變動': '氣候變化',
                        '全球暖化': '全球變暖',
                        '溫室氣體': 'GHG',
                        '碳排放': '溫室氣體排放',
                        '碳足跡': '碳排放量',
                        '風險評估': '風險識別和評估',
                        '風險管控': '風險管理',
                        '實體風險': '物理風險',
                        '轉型風險': '轉換風險',
                        '財務影響': '財務效應',
                        '財務衝擊': '財務影響',
                        '資本配置': '資源配置',
                        '投資決策': '資本配置決策',
                        '公司治理': '治理結構',
                        '董事會': '治理機構',
                        '永續委員會': '永續性委員會',
                        '資訊揭露': '信息披露',
                        '透明度': '透明性',
                        '報告準則': '披露準則'
                    };
                }

                normalizeTerminology(text) {
                    const terminologyDict = this.getTerminologyDict();
                    let normalizedText = text;
                    
                    for (const [original, standard] of Object.entries(terminologyDict)) {
                        const regex = new RegExp(original.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
                        normalizedText = normalizedText.replace(regex, standard);
                    }
                    
                    return normalizedText;
                }

                // 基於關鍵詞的離線分析
                async getKeywordBasedScores(source, candidates) {
                    const sourceTokens = tokenize(source).filter(t => !STOPWORDS.has(t) && t.length > 1);
                    const sourceSet = new Set(sourceTokens);
                    
                    return candidates.map(candidate => {
                        const candidateTokens = tokenize(candidate).filter(t => !STOPWORDS.has(t) && t.length > 1);
                        const candidateSet = new Set(candidateTokens);
                        
                        // 計算 Jaccard 相似度
                        let intersection = 0;
                        sourceSet.forEach(token => {
                            if (candidateSet.has(token)) intersection++;
                        });
                        
                        const union = sourceSet.size + candidateSet.size - intersection;
                        const jaccardScore = union === 0 ? 0 : intersection / union;
                        
                        // 調整分數範圍並加入一些隨機性以模擬語義分析
                        const adjustedScore = Math.min(jaccardScore * 2, 1.0);
                        return Math.max(0, adjustedScore);
                    });
                }

                async encodeTexts(texts) {
                    throw new Error('Local encoding service not available - using fallback analysis');
                }

                async calculateSimilarity(sourceEmbedding, candidateEmbeddings) {
                    throw new Error('Local similarity service not available - using fallback analysis');
                }

                async getLocalSemanticScores(source, candidates, threshold = 0.3) {
                    try {
                        // 根據選擇的模型決定分析方法
                        if (currentModelMode === 'keyword-fallback') {
                            console.log('使用關鍵詞匹配分析...');
                            return this.fallbackAnalysis(source, candidates);
                        }
                        
                        console.log(`使用${currentModelMode}模型進行語義分析...`);
                        
                        // 動態選擇端點和API路徑
                        const endpoint = getSelectedModelEndpoint();
                        const apiPath = getSelectedModelApiPath();
                        
                        let requestBody;
                        
                        // 根據模型類型構建不同的請求體
                        if (currentModelMode === 'dual-model') {
                            requestBody = {
                                source: source,
                                candidates: candidates
                            };
                        } else {
                            requestBody = {
                                source: source,
                                candidates: candidates
                            };
                        }
                        
                        // 發送請求
                        const response = await fetch(`${endpoint}${apiPath}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(requestBody),
                        });

                        if (!response.ok) {
                            throw new Error(`Smart similarity request failed: ${response.status}`);
                        }

                        const result = await response.json();
                        let similarities;
                        
                        // 根據不同模型處理返回結果
                        if (currentModelMode === 'dual-model') {
                            similarities = result.similarities || result.scores || [];
                            
                            // 雙模型詳細信息
                            console.log(`[${currentModelMode}] 雙模型分析完成`);
                            console.log(`分數: ${similarities.length} 項`);
                            console.log(`使用模型: ${result.model_used || 'dual-gemma-qwen3-fused'}`);
                            console.log(`處理時間: ${result.processing_time?.toFixed(3)}秒`);
                            
                            if (similarities.length > 0) {
                                const maxScore = Math.max(...similarities);
                                const minScore = Math.min(...similarities);
                                console.log(`分數範圍: ${minScore.toFixed(4)} - ${maxScore.toFixed(4)}`);
                            }
                            
                        } else {
                            similarities = result.scores || [];
                            
                            // 單模型詳細信息
                            console.log(`[${currentModelMode}] 單模型分析完成`);
                            const nz = similarities.filter(s => Math.abs(s) > 1e-12).length;
                            const min = similarities.length ? Math.min(...similarities) : 0;
                            const max = similarities.length ? Math.max(...similarities) : 0;
                            
                            console.log(`分數: ${similarities.length} 項, 非零: ${nz}, 範圍: ${min.toFixed(4)} - ${max.toFixed(4)}`);
                            
                            if (result.max_primary !== undefined) {
                                console.log(`主要模型最高分: ${result.max_primary.toFixed(4)}`);
                            }
                            
                            if (result.used_fallback) {
                                console.log(`已啟用備援模型, 備援最高分: ${result.max_fallback?.toFixed(4)}`);
                            }
                        }
                        
                        return similarities;
                    } catch (error) {
                        console.error('Smart semantic analysis failed:', error);
                        // 備援：使用基礎關鍵詞分析
                        console.log('本地服務不可用，使用基礎關鍵詞匹配...');
                        return await this.getKeywordBasedScores(source, candidates);
                    }
                }

                async getBasicLocalSemanticScores(source, candidates) {
                    console.log('使用基礎關鍵詞匹配分析...');
                    return await this.getKeywordBasedScores(source, candidates);
                }

                async getMultiLevelSemanticScores(queryTitle, queryContent, candidateSentences, candidateParagraphs, customWeights = null) {
                    try {
                        console.log('使用多層級語義分析（句子+段落+加權整合）...');
                        
                        const defaultWeights = {
                            "title_weight": 0.3,
                            "content_weight": 0.4,
                            "sentence_weight": 0.15,
                            "paragraph_weight": 0.15
                        };
                        
                        const weights = customWeights || defaultWeights;
                        
                        // 優先嘗試NPU增強服務
                        try {
                            console.log('嘗試使用NPU增強多層級分析...');
                            const queryText = [queryTitle, queryContent].filter(Boolean).join(' ');
                            const allCandidates = [...candidateSentences, ...candidateParagraphs];
                            
                            const npuResponse = await fetch('http://localhost:8004/accelerated_similarity', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    source: queryText,
                                    candidates: allCandidates,
                                    model: getCurrentModelType()
                                }),
                            });

                            if (npuResponse.ok) {
                                const npuData = await npuResponse.json();
                                if (npuData.similarities && Array.isArray(npuData.similarities)) {
                                    console.log(`[NPU-MULTILEVEL] OK. scores length=${npuData.similarities.length}`);
                                    // 後端未提供 similarity_details，設為 null
                                    window.lastSimilarityDetails = null;
                                    
                                    // 分離句子和段落分數
                                    const sentenceScores = npuData.similarities.slice(0, candidateSentences.length);
                                    const paragraphScores = npuData.similarities.slice(candidateSentences.length);
                                    
                                    return {
                                        weighted_scores: {
                                            sentence_level: sentenceScores,
                                            paragraph_level: paragraphScores
                                        },
                                        analysis: {
                                            max_weighted_score: Math.max(...npuData.similarities),
                                            npu_enhanced: true,
                                            processing_time: npuData.processing_time
                                        }
                                    };
                                }
                            }
                        } catch (npuError) {
                            console.log('NPU多層級分析失敗，使用備援API:', npuError.message);
                        }
                        
                        // 備援：使用原有的多層級API
                        const response = await fetch('http://localhost:8003/advanced_similarity', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                query_title: queryTitle || "",
                                query_content: queryContent,
                                candidate_sentences: candidateSentences,
                                candidate_paragraphs: candidateParagraphs,
                                weights: weights,
                                threshold: 0.3
                            }),
                        });

                        if (!response.ok) {
                            throw new Error(`Multi-level similarity request failed: ${response.status}`);
                        }

                        const result = await response.json();
                        
                        console.log(`[MULTI-SIM] 多層級分析完成`);
                        console.log(`[MULTI-SIM] 最高加權分數: ${result.analysis.max_weighted_score.toFixed(4)}`);
                        console.log(`[MULTI-SIM] 句子分析: 最高${result.analysis.sentence_analysis.max_score?.toFixed(4) || 'N/A'}, 數量${result.analysis.sentence_analysis.count || 0}`);
                        console.log(`[MULTI-SIM] 段落分析: 最高${result.analysis.paragraph_analysis.max_score?.toFixed(4) || 'N/A'}, 數量${result.analysis.paragraph_analysis.count || 0}`);
                        console.log(`[MULTI-SIM] 權重分配:`, result.analysis.weight_distribution);
                        
                        return result;
                    } catch (error) {
                        console.error('Multi-level semantic analysis failed:', error);
                        console.log('本地服務不可用，使用離線關鍵詞分析...');
                        
                        const queryText = [queryTitle, queryContent].filter(Boolean).join(' ');
                        const sentenceScores = await this.getKeywordBasedScores(queryText, candidateSentences);
                        const paragraphScores = await this.getKeywordBasedScores(queryText, candidateParagraphs);
                        
                        return {
                            weighted_scores: {
                                sentence_level: sentenceScores,
                                paragraph_level: paragraphScores
                            },
                            analysis: {
                                max_weighted_score: Math.max(...sentenceScores, ...paragraphScores),
                                sentence_analysis: { count: sentenceScores.length, max_score: Math.max(...sentenceScores) },
                                paragraph_analysis: { count: paragraphScores.length, max_score: Math.max(...paragraphScores) },
                                weight_distribution: { title_weight: 0.3, content_weight: 0.4, sentence_weight: 0.15, paragraph_weight: 0.15 }
                            }
                        };
                    }
                }

                generateExplanation(matchResult, article) {
                    // 生成匹配解釋說明
                    const explanations = [];
                    
                    if (matchResult.analysis) {
                        const analysis = matchResult.analysis;
                        
                        // 總體分數說明
                        explanations.push(` 總體匹配度: ${(analysis.max_weighted_score * 100).toFixed(1)}%`);
                        
                        // 權重分配說明
                        const weights = analysis.weight_distribution;
                        if (weights.title_weight > 0) {
                            explanations.push(` 標題權重: ${(weights.title_weight * 100)}%`);
                        }
                        if (weights.content_weight > 0) {
                            explanations.push(` 內容權重: ${(weights.content_weight * 100)}%`);
                        }
                        
                        // 句子層級分析
                        if (analysis.sentence_analysis && analysis.sentence_analysis.count > 0) {
                            const sentenceMax = (analysis.sentence_analysis.max_score * 100).toFixed(1);
                            explanations.push(` 句子層級: 最高匹配 ${sentenceMax}% (${analysis.sentence_analysis.count} 個句子)`);
                        }
                        
                        // 段落層級分析
                        if (analysis.paragraph_analysis && analysis.paragraph_analysis.count > 0) {
                            const paragraphMax = (analysis.paragraph_analysis.max_score * 100).toFixed(1);
                            explanations.push(` 段落層級: 最高匹配 ${paragraphMax}% (${analysis.paragraph_analysis.count} 個段落)`);
                        }
                        
                        // 匹配質量評估
                        if (analysis.max_weighted_score > 0.7) {
                            explanations.push(` 高度匹配 - 內容高度相關`);
                        } else if (analysis.max_weighted_score > 0.4) {
                            explanations.push(` 中度匹配 - 有相關性但可加強`);
                        } else if (analysis.max_weighted_score > 0.2) {
                            explanations.push(`⚪ 低度匹配 - 相關性較低`);
                        } else {
                            explanations.push(` 幾乎無匹配 - 建議檢視內容相關性`);
                        }
                    }
                    
                    return explanations.join('\n');
                }
            }

            // 初始化本地分析器
            const localAnalyzer = new LocalSemanticAnalyzer();

            // === 前端優化功能集成 ===

            // 系統配置對象
            const systemConfig = {
                selectedModel: 'multi-level',
                tokenLimit: 4096,
                threshold: 0.3,
                weights: {
                    title_weight: 0.2,    // 降低標題權重：避免過度依賴標題
                    content_weight: 0.5,  // 提高內容權重：重視條文內容匹配
                    sentence_weight: 0.2, // 提高句子權重：重視細節語義
                    paragraph_weight: 0.1 // 降低段落權重：避免上下文干擾
                },
                gpuStatus: 'unknown',
                // 新增的配置項
                pdfQuality: 'standard',           // PDF處理品質
                languagePreference: 'auto',       // 語言偏好
                pageLimit: 50,                    // 頁數處理上限
                memoryOptimization: false,        // 記憶體優化
                parallelProcessing: 'medium',     // 並行處理
                pdfRenderScale: 1.5,             // PDF渲染縮放比例
                exportFormats: {                  // 導出格式設置
                    html: true,
                    json: false,
                    excel: false,
                    pdf: false
                },
                primaryModel: 'unknown'
            };

            // System initialization will be handled in the main execution block

            async function initializeSystemStatus() {
                // 系統狀態面板已移除
                // const statusPanel = document.getElementById('systemStatus');
                // if (statusPanel) {
                //     statusPanel.style.display = 'block';
                // }
                
                // 初始化模型選擇狀態
                console.log(' 初始化模型選擇系統...');
                console.log(` 當前選擇模型: ${currentModelMode}`);

                // 檢查本地服務狀態
                await checkLocalServiceStatus();
                
                console.log(' 前端優化功能已啟用');
            }

            async function checkLocalServiceStatus() {
                try {
                    // 檢查加速版雙模型融合服務健康狀態
                    const response = await fetchWithTimeout('http://localhost:8004/health', { cache: 'no-store' }, 6000);
                    if (response.ok) {
                        const healthData = await response.json();
                        updateSystemStatus(healthData);
                    } else {
                        throw new Error('Service unavailable');
                    }
                } catch (error) {
                    console.log('本地服務不可用，將使用備援模式');
                    updateSystemStatus(null);
                }
            }

            function updateSystemStatus(healthData) {
                console.log("[DEBUG] Health Check Data:", healthData);
                // 系統狀態面板元素已移除，添加null檢查
                const gpuStatusElement = document.getElementById('gpuStatus');
                const primaryModelElement = document.getElementById('primaryModel');
                const tokenSupportElement = document.getElementById('tokenSupport');
                const semanticStatusElement = document.getElementById('status-semantic');

                if (healthData && healthData.status === 'healthy') {
                    // 更新GPU/NPU加速狀態 - 檢測MPS支援（系統狀態面板已移除，跳過更新）
                    if (gpuStatusElement) {
                        if (healthData.device === 'mps' || healthData.mps_available) {
                            gpuStatusElement.innerHTML = ' MPS加速 (Metal Performance Shaders)';
                            gpuStatusElement.style.color = '#388e3c';
                        } else if (healthData.device === 'cuda') {
                            gpuStatusElement.innerHTML = ' CUDA加速';
                            gpuStatusElement.style.color = '#388e3c';
                        } else {
                            gpuStatusElement.innerHTML = ' CPU運算 (高性能優化)';
                            gpuStatusElement.style.color = '#f57c00';
                        }
                    }
                    
                    // Check if FAISS acceleration is available（系統狀態面板已移除，跳過更新）
                    if (primaryModelElement) {
                        if (healthData.models && healthData.models.faiss_retrieval) {
                            primaryModelElement.textContent = ' FAISS向量加速 + Sentence Transformers';
                            primaryModelElement.style.color = '#1a73e8';
                        } else if (healthData.models && healthData.models.dual_fusion) {
                            primaryModelElement.textContent = ' 雙模型融合 (Gemma+Qwen3)';
                            primaryModelElement.style.color = '#1a73e8';
                        } else {
                            primaryModelElement.textContent = '服務載入中...';
                            primaryModelElement.style.color = '#ff9800';
                        }
                    }

                    // Check device type and display FAISS acceleration status（系統狀態面板已移除，跳過更新）
                    if (gpuStatusElement) {
                        if (healthData.models && healthData.models.faiss_retrieval) {
                            gpuStatusElement.innerHTML = ' FAISS向量加速 (15-25x)';
                            gpuStatusElement.style.color = '#2e7d32';
                        } else if (healthData.device === 'mps' && healthData.mps_available) {
                            gpuStatusElement.innerHTML = ' GPU加速 (MPS)';
                            gpuStatusElement.style.color = 'green';
                        } else if (healthData.device === 'cpu') {
                            gpuStatusElement.innerHTML = ' 雙模型融合 (CPU)';
                            gpuStatusElement.style.color = '#1a73e8';
                        } else {
                            gpuStatusElement.innerHTML = ' 雙模型融合';
                            gpuStatusElement.style.color = 'green';
                        }
                    }

                    // FAISS accelerated service settings（系統狀態面板已移除，跳過更新）
                    if (tokenSupportElement) {
                        if (healthData.models && healthData.models.faiss_retrieval) {
                            tokenSupportElement.textContent = '2048 tokens (FAISS混合檢索)';
                        } else {
                            tokenSupportElement.textContent = '2048 tokens (雙模型融合)';
                        }
                    }

                    // Update Semantic Service line with FAISS acceleration info
                    if (semanticStatusElement) {
                        const device = healthData.device || 'cpu';
                        let modelName = 'semantic-service';
                        if (healthData.models && healthData.models.faiss_retrieval) {
                            modelName = 'faiss-hybrid-accelerated';
                        } else if (healthData.models && healthData.models.dual_fusion) {
                            modelName = 'dual-gemma-qwen3-fused';
                        }
                        semanticStatusElement.textContent = `Online (${modelName}, ${device})`;
                    }
                } else {
                    // Fallback for when service is offline or wrong format（系統狀態面板已移除，跳過更新）
                    if (gpuStatusElement) {
                        gpuStatusElement.innerHTML = ' 服務離線';
                        gpuStatusElement.style.color = 'red';
                    }
                    if (primaryModelElement) {
                        primaryModelElement.textContent = '遠程API模式 (備援)';
                        primaryModelElement.style.color = '#d93025';
                    }
                    if (tokenSupportElement) {
                        tokenSupportElement.textContent = '4096 tokens (增強)';
                    }

                    // Ensure Semantic Service line reflects offline fallback
                    if (semanticStatusElement) {
                        semanticStatusElement.textContent = 'Offline (使用關鍵詞匹配)';
                    }
                }
                // 系統狀態面板已移除
                // document.getElementById('systemStatus').style.display = 'block';
            }

            function setupEventListeners() {
                // 模型選擇變更
                const modelSelect = document.getElementById('modelSelection');
                if (modelSelect) {
                    modelSelect.addEventListener('change', function() {
                        systemConfig.selectedModel = this.value;
                        console.log(`切換分析模型: ${this.value}`);
                        updateProcessingMode();
                    });
                }

                // Token限制變更
                const tokenSelect = document.getElementById('tokenLimit');
                if (tokenSelect) {
                    tokenSelect.value = systemConfig.tokenLimit;
                    tokenSelect.addEventListener('change', function() {
                        systemConfig.tokenLimit = parseInt(this.value);
                        console.log(`Token限制設為: ${this.value}`);
                    });
                }

                // 閾值變更
                const thresholdSlider = document.getElementById('similarityThreshold');
                if (thresholdSlider) {
                    thresholdSlider.addEventListener('input', function() {
                        systemConfig.threshold = parseFloat(this.value);
                    });
                }

                // 模型選擇面板事件監聽器
                setupModelSelectionListeners();
            }

            function updateProcessingMode() {
                const processingModeElement = document.getElementById('processingMode');
                const modeMap = {
                    'multi-level': ' 多層級分析',
                    'smart-fallback': ' 智慧備援',
                    'basic-local': ' 基礎本地',
                    'remote-api': ' 遠程API'
                };
                
                if (processingModeElement) {
                    processingModeElement.innerHTML = `<span style="color: #4caf50;">${modeMap[systemConfig.selectedModel] || '未知'}</span>`;
                }
            }

            function setupModelSelectionListeners() {
                const modelOptions = document.querySelectorAll('.model-option input[type="radio"]');
                
                modelOptions.forEach(radio => {
                    radio.addEventListener('change', function() {
                        if (this.checked) {
                            // 更新選中狀態的視覺效果
                            document.querySelectorAll('.model-option').forEach(option => {
                                option.classList.remove('selected');
                            });
                            
                            this.closest('.model-option').classList.add('selected');
                            
                            // 更新全局模型配置
                            const selectedModel = this.value;
                            updateSelectedModel(selectedModel);
                            
                            console.log(` 模型切換至: ${selectedModel}`);
                        }
                    });
                });
            }

            function updateSelectedModel(modelType) {
                // 更新全局配置
                currentModelMode = modelType === 'dual' ? 'dual-model' : `single-${modelType}`;
                
                // 更新模型端點配置
                switch(modelType) {
                    case 'gemma':
                        modelEndpoints['single-gemma'] = 'http://localhost:8004';
                        break;
                    case 'qwen':
                        modelEndpoints['single-qwen'] = 'http://localhost:8004';
                        break;
                    case 'dual':
                        modelEndpoints['dual-model'] = 'http://localhost:8004';
                        break;
                }
                
                // 更新狀態顯示
                updateModelStatus(modelType);
                
                // 如果有分析結果，可以選擇性重新分析
                // 這裡暫時不自動重新分析，讓用戶手動觸發
            }

            function updateModelStatus(modelType) {
                const statusElement = document.getElementById('modelStatus');
                const statusMap = {
                    'gemma': {
                        indicator: '',
                        text: '當前模式：EmbeddingGemma 模型',
                        color: 'rgba(66, 133, 244, 0.1)',
                        borderColor: 'rgba(66, 133, 244, 0.3)'
                    },
                    'qwen': {
                        indicator: '', 
                        text: '當前模式：Qwen3-Embedding 模型',
                        color: 'rgba(255, 152, 0, 0.1)',
                        borderColor: 'rgba(255, 152, 0, 0.3)'
                    },
                    'dual': {
                        indicator: '',
                        text: '當前模式：雙模型融合 (Gemma + Qwen3)',
                        color: 'rgba(52, 168, 83, 0.1)',
                        borderColor: 'rgba(52, 168, 83, 0.3)'
                    }
                };
                
                const config = statusMap[modelType];
                if (statusElement && config) {
                    statusElement.style.background = config.color;
                    statusElement.style.borderColor = config.borderColor;
                    
                    const indicatorElement = statusElement.querySelector('.status-indicator');
                    const textElement = statusElement.querySelector('.status-text');
                    
                    if (indicatorElement) indicatorElement.textContent = config.indicator;
                    if (textElement) textElement.textContent = config.text;
                }
            }

            function getCurrentModelType() {
                const checkedRadio = document.querySelector('.model-option input[type="radio"]:checked');
                return checkedRadio ? checkedRadio.value : 'dual';
            }





            // 模型配置 - 更新為加速版服務
            let currentModelMode = 'dual-model';
            let modelEndpoints = {
                'dual-model': 'http://localhost:8004',  // 加速版服務
                'single-gemma': 'http://localhost:8004',
                'single-qwen': 'http://localhost:8004',
                'keyword-fallback': 'local'
            };


            function getSelectedModelEndpoint() {
                                return modelEndpoints[currentModelMode] || 'http://localhost:8002';
            }

            function getSelectedModelApiPath() {
                switch(currentModelMode) {
                    case 'dual-model':
                        return '/accelerated_similarity';  // 使用加速版端點
                    case 'single-gemma':
                    case 'single-qwen':
                        return '/accelerated_similarity';  // 使用加速版端點
                    default:
                        return '/accelerated_similarity';  // 默認使用加速版
                }
            }


            // 增強版語義分析函數，支援本地和遠程API
            //  新增：批量語義分析函數
            async function getBatchSemanticScores(source, candidatesBatch) {
                try {
                    console.log(` 批量語義分析: ${candidatesBatch.length}個文本組`);
                    
                    const response = await fetch('http://localhost:8004/batch_similarity', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            source: source,
                            candidates_batch: candidatesBatch,
                            model: getCurrentModelType()
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        console.log(` 批量處理結果: ${data.batch_size}個批次, 性能提升: ${data.performance_gain}`);
                        return data.batch_results;
                    } else {
                        throw new Error(`Batch similarity request failed: ${response.status}`);
                    }
                } catch (error) {
                    console.error('批量語義分析失敗，降級為單次處理:', error);
                    // 降級為逐一處理
                    const results = [];
                    for (const candidates of candidatesBatch) {
                        const result = await getSemanticScores(source, candidates);
                        results.push({
                            similarities: result,
                            candidates_count: candidates.length
                        });
                    }
                    return results;
                }
            }

            async function getSemanticScores(source, candidates) {
                // 首先嘗試本地分析
                try {
                    console.log('嘗試使用本地語義分析...');
                    return await localAnalyzer.getLocalSemanticScores(source, candidates);
                } catch (localError) {
                    console.log('本地分析失敗，切換到遠程API:', localError.message);
                }

                // 優先：嘗試使用NPU增強服務
                try {
                    console.log('嘗試使用NPU增強語義分析服務...');
                    const response = await fetch('http://localhost:8002/similarity', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            source: source,
                            candidates: candidates,
                            model: 'dual'
                        }),
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.similarities && Array.isArray(data.similarities)) {
                            console.log(`[NPU-API] OK. scores length=${data.similarities.length}`);
                            window.lastSimilarityDetails = null;
                            return data.similarities;
                        }
                    }
                } catch (npuError) {
                    console.log('NPU服務連接失敗，嘗試備援API:', npuError.message);
                }

                // 備援：使用原有的遠程API
                try {
                    const response = await fetch('http://localhost:8003/calculate_similarity/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            source: source,
                            candidates: candidates,
                            threshold: 0.3
                        }),
                    });

                    if (!response.ok) {
                        console.error('Semantic similarity API request failed:', response.status, response.statusText);
                        return new Array(candidates.length).fill(0); // Fallback
                    }

                    const data = await response.json();
                    const scores = Array.isArray(data.scores) ? data.scores : new Array(candidates.length).fill(0);
                    const nz = scores.filter(s => Math.abs(s) > 1e-12).length;
                    const min = scores.length ? Math.min(...scores) : 0;
                    const max = scores.length ? Math.max(...scores) : 0;
                    console.log(`[REMOTE-API] OK. scores length=${scores.length} nz=${nz} min=${min.toFixed(4)} max=${max.toFixed(4)}`);
                    return scores;
                } catch (error) {
                    console.error('Error calling semantic similarity API:', error);
                    console.log('使用離線關鍵詞匹配作為最後備援...');
                    return await localAnalyzer.getKeywordBasedScores(source, candidates);
                }
            }

            // 條文特定分析函數 - 解決證據重複問題
            async function getArticleSpecificAnalysis(article, allSentencesText, allParagraphsText) {
                try {
                    console.log(` 開始條文特定分析: ${article.id}`);
                    
                    // 優先使用條文特定分析端點
                    const response = await fetch('http://localhost:8004/analyze_specific_article', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            article: article,
                            document_sentences: allSentencesText.slice(0, 500),
                            document_paragraphs: allParagraphsText.slice(0, 200)
                        }),
                    });

                    if (response.ok) {
                        const result = await response.json();
                        console.log(` 條文特定分析成功: ${article.id}, 證據數: ${result.result?.evidences?.length || 0}`);
                        
                        // 轉換為前端期望格式
                        const evidences = result.result?.evidences || [];
                        const sentenceScores = new Array(allSentencesText.length).fill(0);
                        const paragraphScores = new Array(allParagraphsText.length).fill(0);
                        
                        // 將條文特定的證據映射回分數陣列
                        evidences.forEach(evidence => {
                            if (evidence.type === 'sentence' && evidence.index < sentenceScores.length) {
                                sentenceScores[evidence.index] = evidence.similarity;
                            } else if (evidence.type === 'paragraph' && evidence.index < paragraphScores.length) {
                                paragraphScores[evidence.index] = evidence.similarity;
                            }
                        });
                        
                        return {
                            sentenceScores,
                            paragraphScores,
                            analysis: {
                                max_weighted_score: result.result?.max_similarity || 0,
                                article_specific: true,
                                evidence_count: evidences.length
                            },
                            explanation: `條文特定分析完成，找到 ${evidences.length} 個相關證據`
                        };
                    } else {
                        console.log(`條文特定分析失敗，回退到傳統分析: ${article.id}`);
                        return await getMultiLevelSemanticAnalysis(article, allSentencesText, allParagraphsText);
                    }
                } catch (error) {
                    console.error(`條文特定分析錯誤: ${article.id}`, error);
                    return await getMultiLevelSemanticAnalysis(article, allSentencesText, allParagraphsText);
                }
            }

            // 多層級語義分析函數（整合前端配置）
            async function getMultiLevelSemanticAnalysis(article, allSentencesText, allParagraphsText) {
                // 根據用戶選擇的分析模式執行不同策略
                switch (systemConfig.selectedModel) {
                    case 'multi-level':
                        return await performMultiLevelAnalysis(article, allSentencesText, allParagraphsText);
                    case 'smart-fallback':
                        return await performSmartFallbackAnalysis(article, allSentencesText, allParagraphsText);
                    case 'basic-local':
                        return await performBasicLocalAnalysis(article, allSentencesText, allParagraphsText);
                    case 'remote-api':
                        return await performRemoteAPIAnalysis(article, allSentencesText, allParagraphsText);
                    default:
                        return await performMultiLevelAnalysis(article, allSentencesText, allParagraphsText);
                }
            }

            async function performMultiLevelAnalysis(article, allSentencesText, allParagraphsText) {
                try {
                    console.log(' 執行多層級語義分析...');
                    
                    const multiLevelResult = await localAnalyzer.getMultiLevelSemanticScores(
                        article.title || "",
                        article.content || "",
                        allSentencesText,
                        allParagraphsText,
                        systemConfig.weights  // 使用用戶配置的權重
                    );
                    
                    return {
                        sentenceScores: multiLevelResult.weighted_scores?.sentence_level || [],
                        paragraphScores: multiLevelResult.weighted_scores?.paragraph_level || [],
                        analysis: multiLevelResult.analysis,
                        explanation: localAnalyzer.generateExplanation(multiLevelResult, article)
                    };
                    
                } catch (error) {
                    console.log('多層級分析失敗，自動切換到智慧備援模式:', error.message);
                    return await performSmartFallbackAnalysis(article, allSentencesText, allParagraphsText);
                }
            }

            async function performSmartFallbackAnalysis(article, allSentencesText, allParagraphsText) {
                try {
                    console.log(' 執行智慧備援分析...');
                    const articleContent = [article.title, article.content].filter(Boolean).join(' ');
                    
                    // 使用用戶配置的閾值
                    const sentenceScores = await localAnalyzer.getLocalSemanticScores(articleContent, allSentencesText, systemConfig.threshold);
                    const paragraphScores = await localAnalyzer.getLocalSemanticScores(articleContent, allParagraphsText, systemConfig.threshold);
                    
                    return {
                        sentenceScores,
                        paragraphScores,
                        analysis: { max_weighted_score: Math.max(...sentenceScores, ...paragraphScores) },
                        explanation: `智慧備援分析完成 (閾值: ${systemConfig.threshold})`
                    };
                } catch (error) {
                    console.log('智慧備援分析失敗，切換到基礎本地分析:', error.message);
                    return await performBasicLocalAnalysis(article, allSentencesText, allParagraphsText);
                }
            }

            async function performBasicLocalAnalysis(article, allSentencesText, allParagraphsText) {
                try {
                    console.log(' 執行基礎本地分析...');
                    const articleContent = [article.title, article.content].filter(Boolean).join(' ');
                    const sentenceScores = await getSemanticScores(articleContent, allSentencesText);
                    const paragraphScores = await getSemanticScores(articleContent, allParagraphsText);
                    
                    return {
                        sentenceScores,
                        paragraphScores,
                        analysis: null,
                        explanation: "基礎本地語義分析"
                    };
                } catch (error) {
                    console.log('基礎本地分析失敗，最後切換到遠程API:', error.message);
                    return await performRemoteAPIAnalysis(article, allSentencesText, allParagraphsText);
                }
            }

            async function performRemoteAPIAnalysis(article, allSentencesText, allParagraphsText) {
                console.log(' 執行遠程API分析...');
                const articleContent = [article.title, article.content].filter(Boolean).join(' ');
                
                // 直接使用遠程API，跳過本地服務
                try {
                    const sentenceScores = await getRemoteSemanticScores(articleContent, allSentencesText);
                    const paragraphScores = await getRemoteSemanticScores(articleContent, allParagraphsText);
                    
                    return {
                        sentenceScores,
                        paragraphScores,
                        analysis: null,
                        explanation: "遠程API語義分析"
                    };
                } catch (error) {
                    console.log('遠程API分析失敗，使用關鍵詞匹配備援:', error.message);
                    return {
                        sentenceScores: new Array(allSentencesText.length).fill(0),
                        paragraphScores: new Array(allParagraphsText.length).fill(0),
                        analysis: null,
                        explanation: "所有語義分析方法失敗，僅使用關鍵詞匹配"
                    };
                }
            }

            async function getRemoteSemanticScores(source, candidates) {
                try {
                    const response = await fetch('http://localhost:8003/calculate_similarity/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            source: source, 
                            candidates: candidates, 
                            threshold: systemConfig.threshold 
                        })
                    });
                    
                    if (!response.ok) throw new Error(`Remote API failed: ${response.status}`);
                    
                    const data = await response.json();
                    return data.scores || new Array(candidates.length).fill(0);
                } catch (error) {
                    console.log('遠程API不可用，使用關鍵詞匹配...');
                    return await localAnalyzer.getKeywordBasedScores(source, candidates);
                }
            }

            async function performAIAnalysis(text, fileName, totalPages, isEnglish) {
                statusElement.textContent = '開始與IFRS S1條文進行比對（批量並行分析）...';
                const results = [];
                const allArticles = isEnglish ? ifrs1EnData.articles : ifrs1Data.articles;
                const articles = allArticles;

                const globalSentences = sentencesByPage.flatMap(p => p.sentences.map(s => ({ page: p.page, sentence: s })));
                const globalParagraphs = paragraphsByPage.flatMap(p => p.paragraphs.map(paragraph => ({ page: p.page, paragraph: paragraph })));

                const allSentencesText = globalSentences.map(s => s.sentence);
                const allParagraphsText = globalParagraphs.map(p => p.paragraph);

                //  條文逐一特定分析架構 - 修復證據重複問題
                const BATCH_SIZE = 6; // 每批處理6個條文
                const batches = [];
                
                for (let i = 0; i < articles.length; i += BATCH_SIZE) {
                    batches.push(articles.slice(i, i + BATCH_SIZE));
                }

                console.log(` 條文逐一特定分析: ${articles.length}條文 分為 ${batches.length}批次, 每批${BATCH_SIZE}條文`);
                
                for (let batchIndex = 0; batchIndex < batches.length; batchIndex++) {
                    const batch = batches[batchIndex];
                    const progress = Math.round(((batchIndex + 1) / batches.length) * 100);
                    statusElement.textContent = `條文特定分析進度 ${progress}% (${batchIndex + 1}/${batches.length} 批次)...`;
                    
                    // 並行處理當前批次的所有條文
                    const batchPromises = batch.map(async (article, indexInBatch) => {
                        const globalIndex = batchIndex * BATCH_SIZE + indexInBatch;
                        console.log(` 條文特定分析 ${globalIndex + 1}/${articles.length}: ${article.id}`);
                        
                        const coreTokens = extractCoreConceptTokens(article);
                        const keywordSet = new Set((Array.isArray(article.keywords) ? article.keywords : []).map(k => normalizeText(k)));

                        // 使用條文特定分析端點 - 解決證據重複問題
                        const analysisResult = await getArticleSpecificAnalysis(article, allSentencesText, allParagraphsText);
                        const { sentenceScores, paragraphScores, analysis, explanation } = analysisResult;

                        const sentenceCandidates = globalSentences.map((gs, index) => {
                        const { coreHit, kwHit, matchedCore } = scoreSentence(gs.sentence, coreTokens, keywordSet);
                        const similarity_detail = window.lastSimilarityDetails && window.lastSimilarityDetails[index] 
                            ? window.lastSimilarityDetails[index] 
                            : null;
                        
                        // 如果有相關度詳細信息，使用其中的相似度值
                        const simValue = similarity_detail ? similarity_detail.similarity : sentenceScores[index];
                        
                        if (similarity_detail && index < 3) {
                            console.log(`句子 ${index} 相關度詳細信息:`, similarity_detail.label, similarity_detail.percentage + '%', '顏色配置:', similarity_detail.colors);
                        }
                        
                        return { ...gs, coreHit, kwHit, sim: simValue, matchedCore, similarity_detail };
                    }).filter(c => c.sim > 0.02); // 真實語義模型：進一步降低門檻以捕捉更細微的語義關聯

                    const paraCandidates = globalParagraphs.map((gp, index) => {
                        const { coreHit, kwHit, matchedCore } = scoreSentence(gp.paragraph, coreTokens, keywordSet);
                        const paragraphDetailIndex = globalSentences.length + index;
                        const similarity_detail = window.lastSimilarityDetails && window.lastSimilarityDetails[paragraphDetailIndex] 
                            ? window.lastSimilarityDetails[paragraphDetailIndex] 
                            : null;
                        
                        // 如果有相關度詳細信息，使用其中的相似度值
                        const simValue = similarity_detail ? similarity_detail.similarity : paragraphScores[index];
                        
                        return { ...gp, coreHit, kwHit, sim: simValue, matchedCore, similarity_detail };
                    }).filter(c => c.sim > 0.02); // 真實語義模型：進一步降低門檻以捕捉更細微的語義關聯

                    // 純語義排序：完全基於NPU計算的向量距離相似度
                    console.log('使用純語義相似度排序，不依賴關鍵字匹配');
                    sentenceCandidates.sort((a, b) => b.sim - a.sim);
                    paraCandidates.sort((a, b) => b.sim - a.sim);
                    const topSentences = sentenceCandidates.slice(0, 4);
                    const topParagraphs = paraCandidates.slice(0, 2);
                    const combined = [...topSentences, ...topParagraphs];

                    const evidences = [];
                    for (const c of combined) {
                        try {
                            const unmatchedCore = coreTokens.filter(t => !c.matchedCore.includes(t)).slice(0, 6);
                            const contentText = c.sentence || c.paragraph || '';
                            
                            // 優先使用AI生成的證據解釋
                            let reasoning = await generateAIReasoning(article, contentText, c.page, c.matchedCore || [], unmatchedCore, c.sim || 0);
                            
                            // 備援：嘗試Transformer API
                            if (!reasoning) {
                                reasoning = await generateTransformerReasoning(article, contentText, c.page, c.matchedCore || [], unmatchedCore);
                            }
                            
                            // 最後備援：使用動態本地生成
                            if (!reasoning) {
                                reasoning = generateDynamicReasoning(article, contentText, c.page, c.matchedCore || [], unmatchedCore, c.sim || 0);
                            }
                            evidences.push({
                                type: c.paragraph ? 'paragraph' : 'sentence',
                                page: c.page,
                                content: contentText,
                                reasoning,
                                coreHit: c.coreHit || 0,
                                kwHit: c.kwHit || 0,
                                sim: c.sim || 0,
                                analysis_level: c.paragraph ? '段落級' : '句子級',
                                similarity_detail: c.similarity_detail || null,  // 保留NPU的詳細相似度信息
                                paragraph: c.paragraph || null  // 用於前端判斷
                            });
                        } catch (err) {
                            console.warn(' 證據生成失敗，使用最小信息備援:', err);
                            const fallbackContent = (c && (c.sentence || c.paragraph)) || '';
                            evidences.push({
                                type: c && c.paragraph ? 'paragraph' : 'sentence',
                                page: (c && c.page) || null,
                                content: fallbackContent,
                                reasoning: '系統在生成解釋時發生錯誤，已保留內容與相似度作為備援。',
                                coreHit: (c && c.coreHit) || 0,
                                kwHit: (c && c.kwHit) || 0,
                                sim: (c && c.sim) || 0,
                                analysis_level: c && c.paragraph ? '段落級' : '句子級',
                                similarity_detail: (c && c.similarity_detail) || null,
                                paragraph: (c && c.paragraph) || null
                            });
                        }
                    }

                        return {
                            article: article.id,
                            articleData: article,
                            evidences,
                            analysis: analysis,
                            explanation: explanation,
                            multilevel_used: analysis !== null
                        };
                    });

                    // 等待當前批次所有條文處理完成
                    const batchResults = await Promise.all(batchPromises);
                    results.push(...batchResults);
                    
                    // 更新整體進度
                    const analysisProgress = 5 + (((batchIndex + 1) * BATCH_SIZE) / articles.length * 90);
                    updateProgress('analysis', Math.min(analysisProgress, 95), `正在比對 ${Math.min((batchIndex + 1) * BATCH_SIZE, articles.length)} / ${articles.length} 條文`);
                    
                    console.log(` 批次 ${batchIndex + 1} 完成: ${batchResults.length}條文 處理完畢`);
                }

                updateProgress('analysis', 100, '分析完成');
                overallStatusEl.textContent = '步驟 3/3: 產生分析報告';
                updateProgress('report', 50, '正在匯總結果...');
                // 在此進行一次性結果過濾：移除沒有有效證據的條文，確保後續UI一致
                const filteredResults = (results || []).filter(r => {
                    const evidences = r.evidences || [];
                    return evidences.length > 0 && evidences.some(ev =>
                        (ev.similarity && ev.similarity > 0.01) ||
                        (ev.sim && ev.sim > 0.01) ||
                        (ev.coreHit && ev.coreHit > 0)
                    );
                });
                console.log(`結果過濾：${filteredResults.length}/${(results || []).length} 條含有效證據的條文將進入報告`);
                analysisReportData = {
                    fileName,
                    totalPages,
                    analysisDate: Date.now(),
                    results: filteredResults
                };
                try {
                    generateIFRSReport();
                    updateProgress('report', 100, '報告已生成');
                    overallStatusEl.textContent = '分析全部完成！';
                } catch (e) {
                    console.error(' 報告生成失敗:', e);
                    if (loadingIndicator) loadingIndicator.style.display = 'none';
                    if (reportContainer) {
                        reportContainer.innerHTML = `
                            <div class="result-card">
                                <h2> 報告生成失敗</h2>
                                <p>發生錯誤：${(e && e.message) ? e.message : e}</p>
                                <p>請開啟瀏覽器控制台查看詳細錯誤日誌。</p>
                            </div>
                        `;
                    }
                }
            }

            // --- Report Generation ---
            function generateIFRSReport() {
                console.log('---  Starting Report Generation ---');
                const { fileName, totalPages, analysisDate, results } = analysisReportData;
                if (!results) {
                    console.error(' Report Generation Aborted: analysisReportData.results is missing.');
                    return;
                }
                console.log(` Found ${results.length} raw analysis results.`);

                // Filter out results with no semantic evidence (only keyword matches)
                const semanticResults = results.filter(r => {
                    const evidences = r.evidences || [];
                    // 適配新的證據結構：檢查 similarity, sim, coreHit 字段
                    return evidences.length > 0 && evidences.some(ev => 
                        (ev.similarity && ev.similarity > 0.3) || 
                        (ev.sim && ev.sim > 0.3) || 
                        (ev.coreHit && ev.coreHit > 0)
                    );
                });

                console.log(` Found ${semanticResults.length} results with semantic evidence after filtering.`);

                // 計算整體評價（移除內容衝突檢測）
                const matchingLevels = calculateMatchingLevels(semanticResults);
                const overallEval = getOverallMatchingRating(matchingLevels);
                const categoriesAnalysis = getCategoriesAnalysis(semanticResults);
                const complianceGaps = getComplianceGaps(results, semanticResults);

                // Sort by article ID (numerical order)
                semanticResults.sort((a, b) => {
                    const aNum = parseInt(a.article.replace(/[^\d]/g, '')) || 0;
                    const bNum = parseInt(b.article.replace(/[^\d]/g, '')) || 0;
                    return aNum - bNum;
                });

                let reportHTML = `
                    <div class="result-card">
                        <h2>IFRS S1 語義分析報告</h2>
                        <div class="stats-grid">
                            <div class="stat-item"><div class="stat-number">${fileName}</div><div class="stat-label">分析文件</div></div>
                            <div class="stat-item"><div class="stat-number">${totalPages}</div><div class="stat-label">總頁數</div></div>
                            <div class="stat-item"><div class="stat-number">${new Date(analysisDate).toLocaleString()}</div><div class="stat-label">分析所花時間</div></div>
                        </div>
                        <p style="font-size: 0.9rem; color: #5f6368;"> 條文按編號順序排列，僅顯示具語義證據之內容（排除純關鍵字匹配）。</p>
                        <p style="font-size: 0.9rem; color: #5f6368;"> 每個條文顯示核心概念匹配和語義相似度證據，證據由AI生成分析解釋。</p>
                    </div>
                `;

                // 新增：整體評價區塊（合規程度、缺點、改善建議，移除內容衝突）
                const lowCategories = Object.entries(categoriesAnalysis || {})
                    .filter(([, data]) => (data && typeof data.avg_similarity === 'number' ? data.avg_similarity : 0) < 0.4)
                    .map(([name]) => name);
                const topGaps = (complianceGaps || []).slice(0, 5);

                reportHTML += `
                    <div class="result-card" style="border-left: 4px solid #1a73e8;">
                        <h2>整體評價</h2>
                        <div style="margin: 8px 0;">
                            <strong>符合程度：</strong>${overallEval.rating.level}（匹配率 ${overallEval.statistics.matchingRate}% 、加權得分 ${overallEval.statistics.weightedScore}%）
                        </div>
                        <div style="margin: 8px 0;">
                            <strong>整體描述：</strong>${overallEval.description}
                        </div>
                        <div style="margin: 8px 0;">
                            <strong>主要缺點 / 缺口：</strong>
                            ${topGaps.length ? (`<ul>` + topGaps.map(g => `<li>${g.article_id}：${g.title}（${g.category || '未分類'}）— ${g.reason}</li>`).join('') + `</ul>`) : '未發現明顯缺口'}
                        </div>
                        <div style="margin: 8px 0;">
                            <strong>改善建議：</strong>
                            <ul>
                                <li>綜合建議：${overallEval.recommendation}</li>
                                ${lowCategories.length ? `<li>優先補強領域：${lowCategories.slice(0,3).join('、')}（平均相似度偏低）</li>` : ''}
                                <li>針對治理：明確董事會/高階管理層在永續議題上的職責、監督機制與報告頻率</li>
                                <li>針對風險管理：補充重大風險識別流程、評估方法、應對機制與監測指標</li>
                                <li>針對指標與目標：提供具體量化指標（基期、範疇、邊界）與年度/中長期目標與進度</li>
                                <li>針對報告基礎：說明彙總口徑、估算方法、資料來源與內外部查核情形</li>
                            </ul>
                        </div>
                    </div>
                `;

                // Article cards in order
                const allArticles = ifrs1Data?.articles || [];
                allArticles.forEach(article => {
                    const articleResult = results.find(r => r.article === article.id) || {
                        article: article.id,
                        articleData: article,
                        evidences: []
                    };

                    // 獲取條文的擴充資訊
                    const categoryIcon = {
                        '治理': '',
                        '策略': '', 
                        '風險管理': '',
                        '指標與目標': '',
                        '報告基礎': ''
                    }[article.category] || '';
                    
                    const difficultyColor = {
                        'high': '#d32f2f',
                        'medium': '#f57c00', 
                        'low': '#388e3c'
                    }[article.difficulty] || '#666';
                    
                    reportHTML += `
                        <div class="result-card article-card">
                            <div class="article-header">
                                <h3 class="result-title">${articleResult.article}: ${article.title || '無標題'}</h3>
                                <div class="article-meta" style="display: flex; gap: 12px; align-items: center;">
                                    <span style="color: ${difficultyColor}; font-weight: 500;">
                                        ${categoryIcon} ${article.category || '一般條文'}
                                    </span>
                                    <span style="color: ${difficultyColor}; font-size: 0.8rem;">
                                        難度: ${article.difficulty === 'high' ? '高' : article.difficulty === 'medium' ? '中' : '低'}
                                    </span>
                                </div>
                            </div>
                            <div style="margin: 12px 0; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #4285f4;">
                                <div style="font-size: 0.9rem; color: #5f6368; line-height: 1.4;">
                                    ${(article.content || '無內容摘要').slice(0, 200)}${(article.content || '').length > 200 ? '...' : ''}
                                </div>
                                ${article.context ? `
                                    <div style="margin-top: 8px; padding: 8px; background: #e3f2fd; border-radius: 4px; font-size: 0.85rem; color: #1565c0;">
                                         ${article.context}
                                    </div>
                                ` : ''}
                                ${article.practical_guidance ? `
                                    <div style="margin-top: 8px; padding: 8px; background: #f3e5f5; border-radius: 4px; font-size: 0.85rem; color: #7b1fa2;">
                                         實務指引: ${article.practical_guidance.slice(0, 100)}${article.practical_guidance.length > 100 ? '...' : ''}
                                    </div>
                                ` : ''}
                            </div>
                            ${articleResult.multilevel_used ? `
                                <div style="margin: 12px 0; padding: 12px; background: #e8f5e8; border-radius: 6px; border-left: 4px solid #34a853;">
                                    <div style="font-weight: 500; color: #1e8e3e; margin-bottom: 8px;"> 多層級語義分析</div>
                                    ${articleResult.analysis?.max_weighted_score ? `
                                        <div style="font-size: 0.9rem; color: #2e7d32; font-weight: 500;">
                                            總體匹配度: ${(articleResult.analysis.max_weighted_score * 100).toFixed(1)}%
                                        </div>
                                    ` : `
                                        <div style="font-size: 0.9rem; color: #137333;">
                                            多層級分析已完成
                                        </div>
                                    `}
                                </div>
                            ` : ''}

                            <div class="evidence-section">
                                <h4 style="margin: 16px 0 8px 0; color: #202124; font-size: 1rem;"> 語義證據分析</h4>
                                <div class="evidence-scrollable" style="max-height: 400px; overflow-y: auto; border: 1px solid #e8eaed; border-radius: 8px; padding: 8px;">
                                    ${articleResult.evidences && articleResult.evidences.length > 0 ? 
                                        articleResult.evidences
                                            .filter(evidence => evidence.sim > 0.03) // 微調門檻：收集更多低相似度但可能有價值的內容
                                            .sort((a, b) => b.sim - a.sim)
                                            .slice(0, 8) // 顯示前8個最相關的證據，增加潛在發現機會
                                            .map(evidence => `
                                                <div class="evidence-item">
                                                    <p class="evidence-text">${evidence.content || ''}</p>
                                                    ${evidence.reasoning ? `
                                                        <div class="evidence-reasoning">
                                                            <span style="color: #1e8e3e; font-weight: 500;"> AI解釋:</span> ${evidence.reasoning}
                                                        </div>
                                                    ` : ''}
                                                    <div class="evidence-meta">
                                                        <span class="page-number">頁碼: ${evidence.page || 'N/A'}</span>
                                                        ${evidence.similarity_detail ? `
                                                            <span class="similarity-level" style="
                                                                background: ${evidence.similarity_detail.colors.bg}; 
                                                                border: 1px solid ${evidence.similarity_detail.colors.border}; 
                                                                color: ${evidence.similarity_detail.colors.text};
                                                                padding: 2px 8px; 
                                                                border-radius: 12px; 
                                                                font-size: 12px; 
                                                                font-weight: 500;
                                                                display: inline-flex;
                                                                align-items: center;
                                                                gap: 3px;
                                                            ">
                                                                ${evidence.similarity_detail.colors.icon} ${evidence.similarity_detail.label} ${evidence.similarity_detail.percentage}%
                                                                <small style="opacity: 0.8;">(${evidence.analysis_level || evidence.paragraph ? '段落級' : '句子級'})</small>
                                                            </span>
                                                        ` : `
                                                            <span class="similarity">相似度: ${(evidence.sim * 100).toFixed(1)}% 
                                                                <small style="opacity: 0.7;">(${evidence.analysis_level || evidence.paragraph ? '段落級' : '句子級'})</small>
                                                            </span>
                                                        `}
                                                    </div>
                                                </div>
                                            `).join('')
                                        : 
                                        '<div class="no-evidence">未找到相關證據</div>'
                                    }
                                </div>
                            </div>
                        </div>
                    `;
                });

                console.log(` Final report HTML generated (length: ${reportHTML.length}). Injecting into reportContainer.`);
                
                // 創建備援顯示機制
                if (reportHTML.length < 1000) {
                    console.warn(' 生成的報告HTML內容過短，可能有問題');
                    reportHTML = `
                        <div style="padding: 20px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; margin: 20px 0;">
                            <h3 style="color: #b8860b;"> 報告生成警告</h3>
                            <p>檢測到報告內容異常短 (${reportHTML.length} 字符)。這可能是由於：</p>
                            <ul>
                                <li>相似度計算返回值過低</li>
                                <li>過濾條件過於嚴格</li>
                                <li>數據格式不匹配</li>
                            </ul>
                            <p><strong>建議：</strong>檢查後端API響應和前端過濾邏輯。</p>
                        </div>
                    `;
                }
                
                reportContainer.innerHTML = reportHTML;
                console.log(' Report HTML injected successfully.');
                
                // 創建更強健的顯示邏輯
                function forceReportVisible() {
                    // 完全重置容器樣式
                    reportContainer.removeAttribute('hidden');
                    reportContainer.removeAttribute('style');
                    
                    // 應用強制可見樣式
                    const forceStyles = {
                        'display': 'block',
                        'visibility': 'visible',
                        'opacity': '1',
                        'position': 'relative',
                        'z-index': '100',
                        'background': 'white',
                        'border': '1px solid #e0e0e0',
                        'border-radius': '8px',
                        'padding': '20px',
                        'margin': '20px auto',
                        'min-height': '200px',
                        'max-width': '1200px',
                        'box-shadow': '0 4px 20px rgba(0,0,0,0.1)'
                    };
                    
                    Object.entries(forceStyles).forEach(([prop, value]) => {
                        reportContainer.style.setProperty(prop, value, 'important');
                    });
                    
                    // 確保父容器鏈都可見
                    let parent = reportContainer.parentElement;
                    while (parent && parent !== document.body) {
                        parent.style.setProperty('display', 'block', 'important');
                        parent.style.setProperty('visibility', 'visible', 'important');
                        parent.style.setProperty('opacity', '1', 'important');
                        parent = parent.parentElement;
                    }
                    
                    return {
                        containerExists: !!reportContainer,
                        contentLength: reportContainer.innerHTML.length,
                        computedDisplay: window.getComputedStyle(reportContainer).display,
                        offsetHeight: reportContainer.offsetHeight,
                        offsetWidth: reportContainer.offsetWidth
                    };
                }
                
                // 強制顯示結果區域並滾動到視圖
                try {
                    const debugInfo = forceReportVisible();
                    console.log(' 強制顯示狀態:', debugInfo);
                    
                    console.log(' Report container forced visible, scrolling into view...');
                    setTimeout(() => {
                        reportContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        console.log(' Scrolled to report container');
                        
                        // 視覺指示器已移除 - 避免分析時出現紅色方格干擾
                        // 如需調試時可重新啟用此指示器
                        
                    }, 300);
                } catch (e) {
                    console.warn('顯示結果區域時發生非關鍵錯誤:', e);
                }
                
                //  顯示導出控制面板並更新信息
                updateExportControls();
                
                loadingIndicator.style.display = 'none';
            }

            //  報告導出功能
            function updateExportControls() {
                console.log(' 正在更新導出控制面板...');
                
                const exportControls = document.getElementById('exportControls');
                const exportFileName = document.getElementById('exportFileName');
                const exportAnalysisDate = document.getElementById('exportAnalysisDate');
                const exportMatchCount = document.getElementById('exportMatchCount');

                if (!exportControls) {
                    console.error(' 找不到導出控制面板元素');
                    return;
                }

                if (!analysisReportData || !analysisReportData.results) {
                    console.warn(' 分析報告數據不存在，隱藏導出控制面板');
                    exportControls.style.display = 'none';
                    return;
                }

                console.log(' 分析報告數據存在:', analysisReportData);

                const { fileName, analysisDate, results } = analysisReportData;
                const semanticResults = results.filter(r => {
                    const evidences = r.evidences || [];
                    return evidences.length > 0 && evidences.some(ev => ev.coreHit > 0 || ev.sim > 0.01);
                });

                // 安全更新UI元素
                if (exportFileName) exportFileName.textContent = fileName || '未知文件';
                if (exportAnalysisDate) exportAnalysisDate.textContent = new Date(analysisDate).toLocaleString();
                if (exportMatchCount) exportMatchCount.textContent = `${semanticResults.length}/${results.length}`;
                
                exportControls.style.display = 'block';
                console.log(' 導出控制面板已顯示');
            }

            //  調試功能：檢查導出功能狀態
            function debugExportStatus() {
                console.log('=== 導出功能調試信息 ===');
                console.log('1. analysisReportData:', analysisReportData);
                console.log('2. exportControls element:', document.getElementById('exportControls'));
                console.log('3. exportFileName element:', document.getElementById('exportFileName'));
                console.log('4. exportAnalysisDate element:', document.getElementById('exportAnalysisDate'));
                console.log('5. exportMatchCount element:', document.getElementById('exportMatchCount'));
                
                const buttons = [
                    'exportReportAsHTML',
                    'exportReportAsJSON', 
                    'exportSemanticEvidence',
                    'printReport'
                ];
                
                buttons.forEach(funcName => {
                    console.log(`6. 函數 ${funcName} 是否存在:`, typeof window[funcName] === 'function');
                });
                
                console.log('=== 調試信息結束 ===');
            }

            //  測試導出功能
            function testExportFunctions() {
                console.log(' 開始測試導出功能...');
                
                // 創建模擬數據用於測試
                const mockData = {
                    fileName: "測試文件.pdf",
                    totalPages: 10,
                    analysisDate: Date.now(),
                    results: [
                        {
                            article: "IFRS-S1-21",
                            articleData: {
                                id: "IFRS-S1-21",
                                title: "治理 - 一般規定",
                                category: "治理",
                                difficulty: "high"
                            },
                            evidences: [
                                {
                                    type: "sentence",
                                    page: 1,
                                    content: "測試語義證據內容",
                                    reasoning: "AI測試分析",
                                    coreHit: 1,
                                    kwHit: 1,
                                    sim: 0.85,
                                    analysis_level: "句子級"
                                }
                            ]
                        }
                    ]
                };
                
                // 暫時設置測試數據
                const originalData = analysisReportData;
                analysisReportData = mockData;
                
                console.log(' 測試數據設置完成，嘗試下載測試檔案...');
                
                // 測試下載功能
                downloadFile("測試內容\n這是一個測試檔案", "導出功能測試.txt", "text/plain");
                
                // 恢復原始數據
                analysisReportData = originalData;
                
                console.log(' 測試完成');
            }

            //  計算匹配度分級統計
            function calculateMatchingLevels(results) {
                const levels = { high: 0, mediumHigh: 0, medium: 0, mediumLow: 0, low: 0 };
                
                results.forEach(result => {
                    const evidences = result.evidences || [];
                    if (evidences.length === 0) return;
                    
                    // 計算該條文的最高相似度
                    const maxSimilarity = Math.max(...evidences.map(ev => ev.sim || 0));
                    
                    // 根據相似度分級
                    if (maxSimilarity >= 0.8) {
                        levels.high++;
                    } else if (maxSimilarity >= 0.6) {
                        levels.mediumHigh++;
                    } else if (maxSimilarity >= 0.4) {
                        levels.medium++;
                    } else if (maxSimilarity >= 0.2) {
                        levels.mediumLow++;
                    } else {
                        levels.low++;
                    }
                });
                
                return levels;
            }

            //  評估相似度等級
            function getSimilarityRating(similarity) {
                if (similarity >= 0.8) return { level: '高', class: 'high', description: '高度相關' };
                if (similarity >= 0.6) return { level: '中高', class: 'medium-high', description: '相當相關' };
                if (similarity >= 0.4) return { level: '中', class: 'medium', description: '中等相關' };
                if (similarity >= 0.2) return { level: '中低', class: 'medium-low', description: '較低相關' };
                return { level: '低', class: 'low', description: '低度相關' };
            }

            //  評估總體匹配度
            function getOverallMatchingRating(levels, totalArticles = 125) {
                const totalMatched = levels.high + levels.mediumHigh + levels.medium + levels.mediumLow + levels.low;
                const matchingRate = totalMatched / totalArticles;
                
                // 計算加權分數 (高匹配度權重更高)
                const weightedScore = (
                    levels.high * 1.0 + 
                    levels.mediumHigh * 0.8 + 
                    levels.medium * 0.6 + 
                    levels.mediumLow * 0.4 + 
                    levels.low * 0.2
                ) / totalMatched;
                
                let rating, description, recommendation;
                
                if (matchingRate >= 0.7 && weightedScore >= 0.7) {
                    rating = { level: '高', class: 'high', score: Math.round(weightedScore * 100) };
                    description = 'ESG報告書與IFRS S1標準高度匹配';
                    recommendation = '報告書已充分滿足IFRS S1要求，建議進行最終審核';
                } else if (matchingRate >= 0.5 && weightedScore >= 0.5) {
                    rating = { level: '中', class: 'medium', score: Math.round(weightedScore * 100) };
                    description = 'ESG報告書與IFRS S1標準中等匹配';
                    recommendation = '報告書基本符合要求，建議補充部分條文內容';
                } else {
                    rating = { level: '低', class: 'low', score: Math.round(weightedScore * 100) };
                    description = 'ESG報告書與IFRS S1標準匹配度較低';
                    recommendation = '報告書需要大幅改善以符合IFRS S1要求';
                }
                
                return {
                    rating,
                    description,
                    recommendation,
                    statistics: {
                        totalMatched,
                        matchingRate: Math.round(matchingRate * 100),
                        weightedScore: Math.round(weightedScore * 100)
                    }
                };
            }

            // 移除detectContentConflicts函數

            // 在頁面加載完成後，將調試和導出函數暴露到全局
            window.debugExportStatus = debugExportStatus;
            window.testExportFunctions = testExportFunctions;
            window.exportReportAsHTML = exportReportAsHTML;
            window.exportReportAsJSON = exportReportAsJSON;
            window.exportSemanticEvidence = exportSemanticEvidence;
            window.printReport = printReport;
            window.previewReportAsHTML = previewReportAsHTML;
            window.downloadReportAsHTML = downloadReportAsHTML;
            window.calculateMatchingLevels = calculateMatchingLevels;
            window.getSimilarityRating = getSimilarityRating;
            window.getOverallMatchingRating = getOverallMatchingRating;

            //  導出完整HTML報告
            function exportReportAsHTML() {
                console.log(' 開始導出HTML報告...');
                
                if (!analysisReportData) {
                    console.error(' 沒有分析報告數據');
                    alert('沒有可導出的報告數據，請先完成PDF分析');
                    return;
                }

                console.log(' 分析報告數據檢查通過，開始生成HTML...');

                const { fileName, totalPages, analysisDate, results } = analysisReportData;
                const semanticResults = results.filter(r => {
                    const evidences = r.evidences || [];
                    return evidences.length > 0 && evidences.some(ev => ev.coreHit > 0 || ev.sim > 0.01);
                });
                
                // 計算匹配度分級
                const matchingLevels = calculateMatchingLevels(semanticResults);
                
                // 計算總體評價
                const overallRating = getOverallMatchingRating(matchingLevels);

                let fullReportHTML = `
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IFRS S1 語義分析報告 - ${fileName}</title>
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; line-height: 1.6; margin: 20px; }
        .header { text-align: center; border-bottom: 2px solid #4285f4; padding-bottom: 20px; margin-bottom: 30px; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 20px 0; }
        .matching-levels { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin: 20px 0; }
        .level-item { text-align: center; padding: 10px; border-radius: 6px; }
        .level-high { background: #e8f5e8; border: 2px solid #4caf50; }
        .level-medium-high { background: #fff3e0; border: 2px solid #ff9800; }
        .level-medium { background: #e3f2fd; border: 2px solid #2196f3; }
        .level-medium-low { background: #fce4ec; border: 2px solid #e91e63; }
        .level-low { background: #ffebee; border: 2px solid #f44336; }
        .overall-rating { margin: 30px 0; padding: 25px; border-radius: 12px; border-left: 6px solid; }
        .rating-high { background: #e8f5e8; border-color: #4caf50; }
        .rating-medium { background: #e3f2fd; border-color: #2196f3; }
        .rating-low { background: #ffebee; border-color: #f44336; }
        .rating-badge { display: inline-block; padding: 8px 16px; border-radius: 20px; color: white; font-weight: bold; margin-right: 15px; }
        .badge-high { background: #4caf50; }
        .badge-medium { background: #2196f3; }
        .badge-low { background: #f44336; }
        .similarity-rating { margin: 5px 0; padding: 5px 10px; border-radius: 15px; font-size: 0.85em; display: inline-block; }
        .sim-high { background: #e8f5e8; color: #2e7d32; border: 1px solid #4caf50; }
        .sim-medium-high { background: #fff3e0; color: #ef6c00; border: 1px solid #ff9800; }
        .sim-medium { background: #e3f2fd; color: #1565c0; border: 1px solid #2196f3; }
        .sim-medium-low { background: #fce4ec; color: #c2185b; border: 1px solid #e91e63; }
        .sim-low { background: #ffebee; color: #d32f2f; border: 1px solid #f44336; }
        .stat-item { text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px; }
        .stat-number { font-size: 1.5em; font-weight: bold; color: #4285f4; }
        .stat-label { color: #666; margin-top: 5px; }
        .article-card { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .article-title { color: #4285f4; font-weight: bold; margin-bottom: 10px; }
        .evidence-item { margin: 15px 0; padding: 15px; background: #f9f9f9; border-left: 4px solid #4285f4; }
        .evidence-meta { font-size: 0.9em; color: #666; margin-bottom: 10px; }
        .evidence-content { margin: 10px 0; padding: 10px; background: white; border-radius: 4px; }
        .similarity-score { font-weight: bold; color: #34a853; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body>
    <div class="header">
        <h1>IFRS S1 語義分析報告</h1>
        <p>生成時間: ${new Date().toLocaleString()}</p>
    </div>
    
    <div class="stats-grid">
        <div class="stat-item"><div class="stat-number">${fileName}</div><div class="stat-label">分析文件</div></div>
        <div class="stat-item"><div class="stat-number">${totalPages}</div><div class="stat-label">總頁數</div></div>
        <div class="stat-item"><div class="stat-number">${semanticResults.length}</div><div class="stat-label">匹配條文數</div></div>
    </div>
    
    <div class="matching-levels">
        <div class="level-item level-high">
            <div class="stat-number">${matchingLevels.high}</div>
            <div class="stat-label">高 (≥80%)</div>
        </div>
        <div class="level-item level-medium-high">
            <div class="stat-number">${matchingLevels.mediumHigh}</div>
            <div class="stat-label">中高 (60-79%)</div>
        </div>
        <div class="level-item level-medium">
            <div class="stat-number">${matchingLevels.medium}</div>
            <div class="stat-label">中 (40-59%)</div>
        </div>
        <div class="level-item level-medium-low">
            <div class="stat-number">${matchingLevels.mediumLow}</div>
            <div class="stat-label">中低 (20-39%)</div>
        </div>
        <div class="level-item level-low">
            <div class="stat-number">${matchingLevels.low}</div>
            <div class="stat-label">低 (<20%)</div>
        </div>
    </div>
    
    <div class="overall-rating rating-${overallRating.rating.class}">
        <h3 style="margin-top: 0; display: flex; align-items: center;">
            <span class="rating-badge badge-${overallRating.rating.class}">總體匹配度：${overallRating.rating.level}</span>
            <span style="font-size: 1.2em; font-weight: bold;">分數：${overallRating.rating.score}分</span>
        </h3>
        <p style="font-size: 1.1em; margin: 15px 0;"><strong>${overallRating.description}</strong></p>
        <p style="margin: 10px 0;"> <strong>專業建議：</strong>${overallRating.recommendation}</p>
        <div style="margin-top: 15px; font-size: 0.9em; color: #666;">
            <span style="margin-right: 20px;"> 條文匹配率：${overallRating.statistics.matchingRate}%</span>
            <span style="margin-right: 20px;"> 加權得分：${overallRating.statistics.weightedScore}%</span>
            <span> 已匹配條文：${overallRating.statistics.totalMatched}/125</span>
        </div>
    </div>
`;

                semanticResults.forEach(result => {
                    const { articleData, evidences } = result;
                    fullReportHTML += `
    <div class="article-card">
        <div class="article-title">${articleData.id}: ${articleData.title}</div>
        <p><strong>類別:</strong> ${articleData.category} | <strong>難度:</strong> ${articleData.difficulty}</p>
        <p><strong>內容:</strong> ${articleData.content}</p>
        
        <h4>語義證據分析</h4>`;

                    evidences.forEach((evidence, index) => {
                        // 適配新的相似度字段結構
                        const similarityValue = evidence.similarity || evidence.sim || 0;
                        const simRating = getSimilarityRating(similarityValue);
                        fullReportHTML += `
        <div class="evidence-item">
            <div class="evidence-meta">
                 頁數: ${evidence.page || 1} |  類型: ${evidence.type || evidence.analysis_level || 'unknown'} | 
                <span class="similarity-score">相似度: ${(similarityValue * 100).toFixed(1)}%</span>
                <span class="similarity-rating sim-${simRating.class}">${simRating.level} - ${simRating.description}</span>
            </div>
            <div class="evidence-content">
                <strong>文本內容:</strong><br>
                ${evidence.content}
            </div>
            <div class="evidence-content">
                <strong>AI分析:</strong><br>
                ${evidence.reasoning}
            </div>
        </div>`;
                    });

                    fullReportHTML += `
    </div>`;
                });

                fullReportHTML += `
    <div class="no-print" style="margin-top: 40px; padding: 20px; background: #f0f8ff; border-radius: 8px;">
        <p><strong>報告說明:</strong></p>
        <ul>
            <li>本報告基於IFRS S1永續相關財務資訊揭露標準進行語義分析</li>
            <li>僅顯示具有語義證據的條文匹配結果</li>
            <li>相似度分數基於雙模型融合算法計算</li>
            <li>AI分析解釋由先進的語言模型生成</li>
        </ul>
    </div>
</body>
</html>`;

                downloadFile(fullReportHTML, `IFRS_S1_分析報告_${fileName}_${new Date().toISOString().split('T')[0]}.html`, 'text/html');
            }

            //  導出分析數據為JSON
            function exportReportAsJSON() {
                console.log(' 開始導出JSON數據...');
                
                if (!analysisReportData) {
                    console.error(' 沒有分析報告數據');
                    alert('沒有可導出的分析數據，請先完成PDF分析');
                    return;
                }

                console.log(' 分析報告數據檢查通過，開始生成JSON...');

                const exportData = {
                    metadata: {
                        fileName: analysisReportData.fileName,
                        totalPages: analysisReportData.totalPages,
                        analysisDate: analysisReportData.analysisDate,
                        exportDate: new Date().toISOString(),
                        tool: "IFRS S1 ESG 報告分析工具 v6.0",
                        model: "dual-gemma-qwen3-fused"
                    },
                    statistics: {
                        totalArticles: analysisReportData.results.length,
                        semanticMatches: analysisReportData.results.filter(r => {
                            const evidences = r.evidences || [];
                            return evidences.length > 0 && evidences.some(ev => ev.coreHit > 0 || ev.sim > 0.01);
                        }).length
                    },
                    results: analysisReportData.results.map(result => ({
                        article: {
                            id: result.articleData.id,
                            title: result.articleData.title,
                            category: result.articleData.category,
                            difficulty: result.articleData.difficulty,
                            content: result.articleData.content,
                            keywords: result.articleData.keywords
                        },
                        analysis: result.analysis,
                        evidences: result.evidences.map(evidence => ({
                            page: evidence.page,
                            type: evidence.type,
                            analysisLevel: evidence.analysis_level,
                            content: evidence.content,
                            reasoning: evidence.reasoning,
                            similarity: evidence.sim,
                            coreConceptHits: evidence.coreHit,
                            keywordHits: evidence.kwHit,
                            similarityDetail: evidence.similarity_detail
                        }))
                    }))
                };

                const jsonString = JSON.stringify(exportData, null, 2);
                downloadFile(jsonString, `IFRS_S1_分析數據_${analysisReportData.fileName}_${new Date().toISOString().split('T')[0]}.json`, 'application/json');
            }

            //  導出語義證據分析
            function exportSemanticEvidence() {
                console.log(' 開始導出語義證據...');
                
                if (!analysisReportData) {
                    console.error(' 沒有分析報告數據');
                    alert('沒有可導出的語義證據，請先完成PDF分析');
                    return;
                }

                console.log(' 分析報告數據檢查通過，開始生成語義證據報告...');

                const { fileName, results } = analysisReportData;
                const semanticResults = results.filter(r => {
                    const evidences = r.evidences || [];
                    return evidences.length > 0 && evidences.some(ev => ev.coreHit > 0 || ev.sim > 0.01);
                });

                let evidenceReport = `IFRS S1 語義證據分析報告\n`;
                evidenceReport += `文件: ${fileName}\n`;
                evidenceReport += `生成時間: ${new Date().toLocaleString()}\n`;
                evidenceReport += `匹配條文: ${semanticResults.length}個\n`;
                evidenceReport += `${'='.repeat(60)}\n\n`;

                semanticResults.forEach((result, index) => {
                    const { articleData, evidences } = result;
                    evidenceReport += `${index + 1}. ${articleData.id}: ${articleData.title}\n`;
                    evidenceReport += `   類別: ${articleData.category} | 難度: ${articleData.difficulty}\n`;
                    evidenceReport += `   內容: ${articleData.content}\n\n`;
                    
                    evidenceReport += `   語義證據 (${evidences.length}項):\n`;
                    evidences.forEach((evidence, evidenceIndex) => {
                        evidenceReport += `   ${evidenceIndex + 1}. [頁${evidence.page}] ${evidence.analysis_level} (相似度: ${(evidence.sim * 100).toFixed(1)}%)\n`;
                        evidenceReport += `      文本: ${evidence.content}\n`;
                        evidenceReport += `      分析: ${evidence.reasoning}\n`;
                        if (evidence.similarity_detail) {
                            evidenceReport += `      詳細: ${evidence.similarity_detail.label} ${evidence.similarity_detail.percentage}%\n`;
                        }
                        evidenceReport += `\n`;
                    });
                    evidenceReport += `${'-'.repeat(50)}\n\n`;
                });

                evidenceReport += `報告說明:\n`;
                evidenceReport += `- 本報告包含所有具語義證據的IFRS S1條文匹配\n`;
                evidenceReport += `- 相似度分數基於雙模型融合語義分析\n`;
                evidenceReport += `- AI分析解釋提供上下文理解\n`;

                downloadFile(evidenceReport, `IFRS_S1_語義證據_${fileName}_${new Date().toISOString().split('T')[0]}.txt`, 'text/plain');
            }

            //  列印報告
            function printReport() {
                if (!analysisReportData) {
                    alert('沒有可列印的報告');
                    return;
                }

                // 創建列印窗口
                const printWindow = window.open('', '_blank');
                const reportContent = document.getElementById('reportContainer').innerHTML;
                
                printWindow.document.write(`
<!DOCTYPE html>
<html>
<head>
    <title>IFRS S1 分析報告 - ${analysisReportData.fileName}</title>
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; line-height: 1.6; margin: 20px; }
        .result-card { margin-bottom: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 20px 0; }
        .stat-item { text-align: center; padding: 10px; background: #f8f9fa; border-radius: 4px; }
        .evidence-block { margin: 15px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .similarity-level { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; }
        @page { margin: 1in; }
        @media print { 
            body { font-size: 12px; }
            .no-print { display: none; }
        }
    </style>
</head>
<body>
    ${reportContent}
    <div style="margin-top: 30px; font-size: 0.9em; color: #666;">
        列印時間: ${new Date().toLocaleString()}
    </div>
</body>
</html>`);
                
                printWindow.document.close();
                printWindow.focus();
                
                // 延遲列印以確保內容載入完成
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                }, 500);
            }

            //  導出PDF報告
            function previewReportAsHTML() {
                console.log(' 開始HTML預覽報告...');
                
                if (!analysisReportData) {
                    console.error(' 沒有分析報告數據');
                    alert('沒有可導出的報告數據，請先完成PDF分析');
                    return;
                }

                const { fileName, totalPages, analysisDate, results } = analysisReportData;
                const semanticResults = results.filter(r => {
                    const evidences = r.evidences || [];
                    return evidences.length > 0 && evidences.some(ev => ev.coreHit > 0 || ev.sim > 0.01);
                });
                
                // 計算匹配度分級
                const matchingLevels = calculateMatchingLevels(semanticResults);
                
                // 計算總體評價
                const overallRating = getOverallMatchingRating(matchingLevels);

                // 創建新窗口用於PDF生成
                const pdfWindow = window.open('', '_blank');
                
                const pdfHTML = `
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IFRS S1 ESG報告分析 - ${fileName}</title>
    <style>
        @page {
            margin: 20mm;
            size: A4;
            @bottom-right {
                content: "此報告由AI生成，作者：游士弘";
                font-size: 10px;
                color: #666;
                margin-right: 5mm;
                margin-bottom: 5mm;
            }
        }
        
        body { 
            font-family: 'Microsoft JhengHei', 'PingFang TC', 'Microsoft YaHei', sans-serif; 
            line-height: 1.6; 
            margin: 0; 
            padding: 20px;
            color: #333;
        }
        
        .header { 
            text-align: center; 
            border-bottom: 3px solid #1a73e8; 
            padding-bottom: 20px; 
            margin-bottom: 30px; 
            page-break-after: avoid;
        }
        
        .header h1 {
            color: #1a73e8;
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header-info {
            color: #666;
            font-size: 14px;
        }
        
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 15px; 
            margin: 20px 0; 
            page-break-inside: avoid;
        }
        
        .matching-levels { 
            display: grid; 
            grid-template-columns: repeat(5, 1fr); 
            gap: 8px; 
            margin: 15px 0; 
            page-break-inside: avoid;
        }
        
        .level-item { 
            text-align: center; 
            padding: 8px; 
            border-radius: 5px;
            font-size: 12px;
        }
        
        .level-high { background: #e8f5e8; border: 1px solid #4caf50; }
        .level-medium-high { background: #fff3e0; border: 1px solid #ff9800; }
        .level-medium { background: #e3f2fd; border: 1px solid #2196f3; }
        .level-medium-low { background: #fce4ec; border: 1px solid #e91e63; }
        .level-low { background: #ffebee; border: 1px solid #f44336; }
        
        .overall-rating { 
            margin: 25px 0; 
            padding: 20px; 
            border-radius: 10px; 
            border-left: 5px solid;
            page-break-inside: avoid;
        }
        .rating-high { background: #e8f5e8; border-color: #4caf50; }
        .rating-medium { background: #e3f2fd; border-color: #2196f3; }
        .rating-low { background: #ffebee; border-color: #f44336; }
        .rating-badge { 
            display: inline-block; 
            padding: 6px 12px; 
            border-radius: 15px; 
            color: white; 
            font-weight: bold; 
            margin-right: 10px;
            font-size: 14px;
        }
        .badge-high { background: #4caf50; }
        .badge-medium { background: #2196f3; }
        .badge-low { background: #f44336; }
        .similarity-rating { 
            margin: 3px 5px; 
            padding: 3px 8px; 
            border-radius: 10px; 
            font-size: 11px; 
            display: inline-block;
        }
        .sim-high { background: #e8f5e8; color: #2e7d32; border: 1px solid #4caf50; }
        .sim-medium-high { background: #fff3e0; color: #ef6c00; border: 1px solid #ff9800; }
        .sim-medium { background: #e3f2fd; color: #1565c0; border: 1px solid #2196f3; }
        .sim-medium-low { background: #fce4ec; color: #c2185b; border: 1px solid #e91e63; }
        .sim-low { background: #ffebee; color: #d32f2f; border: 1px solid #f44336; }
        
        .stat-item { 
            text-align: center; 
            padding: 15px; 
            background: #f8f9fa; 
            border-radius: 8px; 
            border: 1px solid #e0e0e0;
        }
        
        .stat-number { 
            font-size: 20px; 
            font-weight: bold; 
            color: #1a73e8; 
            margin-bottom: 5px;
        }
        
        .stat-label { 
            color: #666; 
            font-size: 14px;
        }
        
        .article-card { 
            margin: 25px 0; 
            padding: 20px; 
            border: 2px solid #e0e0e0; 
            border-radius: 10px; 
            page-break-inside: avoid;
            background: #fafafa;
        }
        
        .article-title { 
            color: #1a73e8; 
            font-weight: bold; 
            font-size: 16px;
            margin-bottom: 10px; 
        }
        
        .article-meta {
            background: #fff;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            border-left: 4px solid #1a73e8;
        }
        
        .evidence-section {
            margin-top: 20px;
        }
        
        .evidence-item { 
            margin: 15px 0; 
            padding: 15px; 
            background: #fff; 
            border-left: 4px solid #34a853; 
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .evidence-meta { 
            font-size: 12px; 
            color: #666; 
            margin-bottom: 10px; 
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .evidence-content { 
            margin: 10px 0; 
            padding: 12px; 
            background: #f9f9f9; 
            border-radius: 5px; 
            font-size: 14px;
            line-height: 1.5;
        }
        
        .similarity-score { 
            font-weight: bold; 
            color: #34a853; 
            background: #e8f5e8;
            padding: 2px 8px;
            border-radius: 12px;
        }
        
        .footer-signature {
            position: fixed;
            bottom: 10mm;
            right: 15mm;
            font-size: 10px;
            color: #666;
            text-align: right;
        }
        
        .page-break {
            page-break-after: always;
        }
        
        @media print { 
            .no-print { display: none; }
            body { font-size: 12px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>IFRS S1 ESG報告分析</h1>
        <div class="header-info">
            <p>基於永續相關財務資訊揭露標準的智慧分析報告</p>
            <p>生成時間：${new Date().toLocaleString()}</p>
        </div>
    </div>
    
    <div class="stats-grid">
        <div class="stat-item">
            <div class="stat-number">${fileName}</div>
            <div class="stat-label">分析文件</div>
        </div>
        <div class="stat-item">
            <div class="stat-number">${totalPages}</div>
            <div class="stat-label">總頁數</div>
        </div>
        <div class="stat-item">
            <div class="stat-number">${semanticResults.length}</div>
            <div class="stat-label">匹配條文數</div>
        </div>
    </div>
    
    <div class="matching-levels">
        <div class="level-item level-high">
            <div class="stat-number">${matchingLevels.high}</div>
            <div class="stat-label">高 (≥80%)</div>
        </div>
        <div class="level-item level-medium-high">
            <div class="stat-number">${matchingLevels.mediumHigh}</div>
            <div class="stat-label">中高 (60-79%)</div>
        </div>
        <div class="level-item level-medium">
            <div class="stat-number">${matchingLevels.medium}</div>
            <div class="stat-label">中 (40-59%)</div>
        </div>
        <div class="level-item level-medium-low">
            <div class="stat-number">${matchingLevels.mediumLow}</div>
            <div class="stat-label">中低 (20-39%)</div>
        </div>
        <div class="level-item level-low">
            <div class="stat-number">${matchingLevels.low}</div>
            <div class="stat-label">低 (<20%)</div>
        </div>
    </div>
    
    <div class="overall-rating rating-${overallRating.rating.class}">
        <h3 style="margin-top: 0; display: flex; align-items: center; flex-wrap: wrap;">
            <span class="rating-badge badge-${overallRating.rating.class}">總體匹配度：${overallRating.rating.level}</span>
            <span style="font-size: 16px; font-weight: bold; margin-left: 10px;">分數：${overallRating.rating.score}分</span>
        </h3>
        <p style="font-size: 15px; margin: 12px 0; line-height: 1.5;"><strong>${overallRating.description}</strong></p>
        <p style="margin: 8px 0; font-size: 14px;"><strong> 專業建議：</strong>${overallRating.recommendation}</p>
        <div style="margin-top: 12px; font-size: 12px; color: #666; line-height: 1.4;">
            <div style="margin-bottom: 4px;"> 條文匹配率：${overallRating.statistics.matchingRate}% |  加權得分：${overallRating.statistics.weightedScore}% |  已匹配條文：${overallRating.statistics.totalMatched}/125</div>
        </div>
    </div>
`;

                semanticResults.forEach((result, index) => {
                    const { articleData, evidences } = result;
                    pdfHTML += `
    <div class="article-card">
        <div class="article-title">${articleData.id}: ${articleData.title}</div>
        <div class="article-meta">
            <p><strong>類別：</strong>${articleData.category} | <strong>難度：</strong>${articleData.difficulty}</p>
            <p><strong>條文內容：</strong>${articleData.content}</p>
        </div>
        
        <div class="evidence-section">
            <h4 style="color: #1a73e8; margin-bottom: 15px;"> 語義證據分析</h4>`;

                    evidences.forEach((evidence, evidenceIndex) => {
                        // 適配新的相似度字段結構
                        const similarityValue = evidence.similarity || evidence.sim || 0;
                        const simRating = getSimilarityRating(similarityValue);
                        pdfHTML += `
            <div class="evidence-item">
                <div class="evidence-meta">
                    <span> 頁數：${evidence.page} |  分析層級：${evidence.analysis_level}</span>
                    <span class="similarity-score">相似度：${(evidence.sim * 100).toFixed(1)}%</span>
                    <span class="similarity-rating sim-${simRating.class}">${simRating.level}</span>
                </div>
                <div class="evidence-content">
                    <strong>文本內容：</strong><br>
                    ${evidence.content}
                </div>
                <div class="evidence-content">
                    <strong>AI智慧分析：</strong><br>
                    ${evidence.reasoning}
                </div>
            </div>`;
                    });

                    pdfHTML += `
        </div>
    </div>`;
                    
                    // 每3個條文後分頁，避免內容過於密集
                    if ((index + 1) % 3 === 0 && index < semanticResults.length - 1) {
                        pdfHTML += '<div class="page-break"></div>';
                    }
                });

                pdfHTML += `
    <div style="margin-top: 40px; padding: 20px; background: #f0f8ff; border-radius: 8px; border: 1px solid #1a73e8;">
        <h3 style="color: #1a73e8; margin-top: 0;"> 報告說明</h3>
        <ul style="line-height: 1.8;">
            <li>本報告基於 IFRS S1 永續相關財務資訊揭露標準進行智慧語義分析</li>
            <li>採用雙模型融合架構（EmbeddingGemma + Qwen3）進行精準語義匹配</li>
            <li>運用 FAISS 向量檢索技術提升分析效率</li>
            <li>分析涵蓋治理、策略、風險管理、指標與目標等四大核心領域</li>
            <li>相似度計算基於語義理解，非單純關鍵詞匹配</li>
        </ul>
        <p style="margin-bottom: 0; color: #666; font-size: 14px;">
            <strong>技術架構：</strong>雙模型融合 + FAISS加速檢索 + 語義映射系統
        </p>
    </div>
    
    <div class="footer-signature">
        此報告由AI生成，作者：游士弘
    </div>
</body>
</html>`;

                pdfWindow.document.write(pdfHTML);
                pdfWindow.document.close();

                // 等待內容載入完成後觸發列印
                setTimeout(() => {
                    pdfWindow.focus();
                    pdfWindow.print();
                    
                    // 列印後關閉窗口
                    pdfWindow.addEventListener('afterprint', () => {
                        pdfWindow.close();
                    });
                }, 1000);

                console.log(' HTML預覽窗口已開啟，請選擇"另存為PDF"進行下載');
            }

            // HTML報告下載功能
            function downloadReportAsHTML() {
                console.log(' 開始生成HTML報告...');
                
                if (!analysisReportData) {
                    console.error(' 沒有分析報告數據');
                    alert('沒有可導出的報告數據，請先完成分析');
                    return;
                }

                const { fileName, totalPages, analysisDate, results } = analysisReportData;
                const semanticResults = results.filter(r => {
                    const evidences = r.evidences || [];
                    return evidences.length > 0 && evidences.some(ev => 
                        (ev.similarity && ev.similarity > 0.3) || 
                        (ev.sim && ev.sim > 0.3) || 
                        (ev.coreHit && ev.coreHit > 0)
                    );
                });
                
                // 計算匹配度分級
                const matchingLevels = calculateMatchingLevels(semanticResults);
                
                // 計算總體評價
                const overallRating = getOverallMatchingRating(matchingLevels);

                // 生成HTML內容
                const htmlContent = generateHTMLContent(fileName, totalPages, semanticResults, matchingLevels, overallRating);

                // 創建並下載HTML文件
                const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `IFRS_S1_分析報告_${fileName.replace(/\.pdf$/i, '')}.html`;
                
                // 觸發下載
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // 清理URL對象
                URL.revokeObjectURL(url);
                
                console.log(' HTML報告已生成並下載');
            }

            // PDF內容生成函數
            function generatePDFContent(fileName, totalPages, semanticResults, matchingLevels, overallRating) {
                const currentDate = new Date().toLocaleString();
                
                let htmlContent = `
                    <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #1976d2; padding-bottom: 20px;">
                        <h1 style="color: #1976d2; margin: 0; font-size: 24px;">IFRS S1 ESG報告分析</h1>
                        <p style="color: #666; margin: 10px 0; font-size: 14px;">基於永續相關財務資訊揭露標準的智慧分析報告</p>
                        <p style="color: #888; margin: 0; font-size: 12px;">生成時間：${currentDate}</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 30px;">
                        <div style="text-align: center; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                            <div style="font-size: 18px; font-weight: bold; color: #1976d2;">${fileName}</div>
                            <div style="font-size: 12px; color: #666;">分析文件</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                            <div style="font-size: 18px; font-weight: bold; color: #1976d2;">${totalPages}</div>
                            <div style="font-size: 12px; color: #666;">總頁數</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                            <div style="font-size: 18px; font-weight: bold; color: #1976d2;">${semanticResults.length}</div>
                            <div style="font-size: 12px; color: #666;">匹配條文</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                            <div style="font-size: 18px; font-weight: bold; color: #1976d2;">${overallRating}</div>
                            <div style="font-size: 12px; color: #666;">整體評價</div>
                        </div>
                    </div>
                `;

                // 添加匹配條文詳細信息
                semanticResults.forEach((result, index) => {
                    const article = result.articleData;
                    const evidences = result.evidences || [];
                    
                    if (evidences.length > 0) {
                        htmlContent += `
                            <div style="margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; page-break-inside: avoid;">
                                <h3 style="color: #1a73e8; border-bottom: 2px solid #1a73e8; padding-bottom: 10px; margin-bottom: 15px;">${article.id}: ${article.title}</h3>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                    <div>
                                        <h4 style="color: #333;">條文內容</h4>
                                        <p style="font-size: 14px; color: #555; line-height: 1.6;">${article.content}</p>
                                    </div>
                                    <div>
                                        <h4 style="color: #333;">關鍵詞</h4>
                                        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                                            ${(article.keywords || []).map(kw => `<span style="background-color: #e8f0fe; color: #1a73e8; padding: 3px 8px; border-radius: 12px; font-size: 12px;">${kw}</span>`).join('')}
                                        </div>
                                    </div>
                                </div>

                                <h4 style="margin-top: 20px; color: #333;">匹配證據</h4>
                                ${evidences.map(e => `
                                    <div style="background-color: #f8f9fa; padding: 10px; margin-top: 10px; border-left: 3px solid #28a745; border-radius: 4px;">
                                        <p style="font-weight: bold;">頁碼: ${e.page}, 相似度: ${(e.sim * 100).toFixed(1)}%</p>
                                        <p style="font-style: italic; color: #555;">“...${e.content}...”</p>
                                        <p style="font-size: 12px; color: #007bff; margin-top: 5px;">分析: ${e.reasoning}</p>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                });

                return htmlContent;
            }

            // 檔案下載輔助函數
            function downloadFile(content, fileName, mimeType) {
                try {
                    console.log(` 準備下載檔案: ${fileName} (${mimeType})`);
                    
                    if (!content) {
                        throw new Error('檔案內容為空');
                    }
                    
                    const blob = new Blob([content], { type: mimeType + ';charset=utf-8' });
                    console.log(` Blob 大小: ${blob.size} bytes`);
                    
                    const link = document.createElement('a');
                    
                    if (link.download !== undefined) {
                        const url = URL.createObjectURL(blob);
                        link.setAttribute('href', url);
                        link.setAttribute('download', fileName);
                        link.style.visibility = 'hidden';
                        
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                        
                        console.log(` 檔案已成功下載: ${fileName}`);
                        
                        // 顯示用戶友好的成功提示
                        if (window.statusElement) {
                            const originalText = window.statusElement.textContent;
                            window.statusElement.textContent = ` 檔案已下載: ${fileName}`;
                            setTimeout(() => {
                                window.statusElement.textContent = originalText;
                            }, 3000);
                        }
                        
                    } else {
                        throw new Error('您的瀏覽器不支援檔案下載功能，請升級瀏覽器版本');
                    }
                    
                } catch (error) {
                    console.error(' 檔案下載失敗:', error);
                    alert(`檔案下載失敗: ${error.message}`);
                }
            }

            // HTML報告內容生成函數
            function generateHTMLContent(fileName, totalPages, semanticResults, matchingLevels, overallRating) {
                const currentDate = new Date().toLocaleString();
                
                let htmlContent = `<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IFRS S1 ESG報告分析 - ${fileName}</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px;
            background-color: #fff;
        }
        .author-info {
            text-align: center;
            background: #f8f9fa;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 8px;
            border-left: 4px solid #1976d2;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #1976d2;
            padding-bottom: 20px;
        }
        .header h1 {
            color: #1976d2;
            margin: 0;
            font-size: 28px;
        }
        .header p {
            color: #666;
            margin: 10px 0;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .summary-item {
            text-align: center;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
        }
        .summary-item .value {
            font-size: 24px;
            font-weight: bold;
            color: #1976d2;
        }
        .summary-item .label {
            font-size: 14px;
            color: #666;
        }
        .article-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
        }
        .article-title {
            color: #1a73e8;
            border-bottom: 2px solid #1a73e8;
            padding-bottom: 10px;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .evidence-item {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-left: 3px solid #4caf50;
            border-radius: 4px;
        }
        .evidence-meta {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        .evidence-content {
            color: #333;
        }
        @media print {
            body { margin: 0; padding: 20px; }
            .summary-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="author-info">
        <h2 style="margin: 0; color: #1976d2;">此報告由AI生成，作者：游士弘</h2>
        <p style="margin: 5px 0; color: #666;">基於IFRS S1永續相關財務資訊揭露標準的智慧分析</p>
    </div>
    
    <div class="header">
        <h1>IFRS S1 ESG報告分析</h1>
        <p>基於永續相關財務資訊揭露標準的智慧分析報告</p>
        <p>生成時間：${currentDate}</p>
    </div>
    
    <div class="summary-grid">
        <div class="summary-item">
            <div class="value">${fileName}</div>
            <div class="label">分析文件</div>
        </div>
        <div class="summary-item">
            <div class="value">${totalPages}</div>
            <div class="label">總頁數</div>
        </div>
        <div class="summary-item">
            <div class="value">${semanticResults.length}</div>
            <div class="label">匹配條文</div>
        </div>
        <div class="summary-item">
            <div class="value">${(overallRating && overallRating.rating) ? `${overallRating.rating.level}（${overallRating.rating.score}分）` : 'N/A'}</div>
            <div class="label">整體評價</div>
        </div>
    </div>
    <div class="article-section">
        <h3 class="article-title">整體評價</h3>
        <p><strong>符合程度：</strong>${(overallRating && overallRating.rating) ? `${overallRating.rating.level}（${overallRating.rating.score}分）` : 'N/A'}；匹配率 ${(overallRating && overallRating.statistics) ? `${overallRating.statistics.matchingRate}%` : '-'}、加權得分 ${(overallRating && overallRating.statistics) ? `${overallRating.statistics.weightedScore}%` : '-'}</p>
        <p><strong>整體描述：</strong>${(overallRating && overallRating.description) ? overallRating.description : ''}</p>
        <p><strong>建議：</strong>${(overallRating && overallRating.recommendation) ? overallRating.recommendation : ''}</p>
    </div>`;

                // 添加匹配條文詳細信息
                semanticResults.forEach((result, index) => {
                    const article = result.articleData;
                    const evidences = result.evidences || [];
                    
                    if (evidences.length > 0) {
                        htmlContent += `
                            <div class="article-section">
                                <h3 class="article-title">${article.id}: ${article.title}</h3>
                                
                                <div style="margin-bottom: 15px;">
                                    <strong>條文內容：</strong>
                                    <p style="background: white; padding: 10px; border-radius: 4px; margin: 5px 0;">${article.content}</p>
                                </div>
                                
                                <div>
                                    <strong>文件證據：</strong>`;
                        
                        evidences.forEach((evidence, evidenceIndex) => {
                            const similarity = (evidence.similarity || evidence.sim || 0) * 100;
                            htmlContent += `
                                <div class="evidence-item">
                                    <div class="evidence-meta">
                                        相似度: ${similarity.toFixed(1)}% | 
                                        類型: ${evidence.source || '語句匹配'} | 
                                        頁面: ${evidence.page || '未知'}
                                    </div>
                                    <div class="evidence-content">${evidence.text || evidence.sentence || '內容未知'}</div>
                                </div>`;
                        });
                        
                        htmlContent += `
                                </div>
                            </div>`;
                    }
                });

                htmlContent += `
</body>
</html>`;
                
                return htmlContent;
            }

            //  IFRS S1 建議書生成功能 (基於 Dual AI Model)
            let currentRecommendationData = null;

            async function generateIFRSRecommendation() {
                if (!analysisReportData || !analysisReportData.results) {
                    alert('請先完成PDF分析後再生成建議書');
                    return;
                }

                // 顯示模態窗口
                document.getElementById('recommendationModal').style.display = 'block';
                document.getElementById('recommendationStatus').textContent = ' AI正在分析分析結果...';
                
                // 重置內容為加載狀態
                document.getElementById('recommendationContent').innerHTML = `
                    <div class="loading-ai">
                        <div class="spinner-ai"></div>
                        <p> 雙AI模型正在分析您的報告並生成IFRS S1建議書...</p>
                        <p style="font-size: 0.9em; color: #888;">結合EmbeddingGemma和Qwen3的語義分析結果</p>
                    </div>`;

                try {
                    // 調用後端dual AI model進行建議書生成
                    const recommendationData = await generateRecommendationWithDualAI();
                    
                    if (recommendationData) {
                        currentRecommendationData = recommendationData;
                        displayRecommendation(recommendationData);
                        document.getElementById('recommendationStatus').textContent = ' 建議書生成完成';
                    } else {
                        throw new Error('無法生成建議書內容');
                    }
                    
                } catch (error) {
                    console.error('建議書生成失敗:', error);
                    document.getElementById('recommendationContent').innerHTML = `
                        <div style="text-align: center; padding: 50px; color: #d93025;">
                            <h3> 生成失敗</h3>
                            <p>無法生成IFRS S1建議書，請檢查網路連接或稍後重試</p>
                            <p style="font-size: 0.9em; color: #666;">錯誤: ${error.message}</p>
                            <button class="recommendation-btn primary" onclick="generateIFRSRecommendation()" style="margin-top: 20px;">
                                 重新嘗試
                            </button>
                        </div>`;
                    document.getElementById('recommendationStatus').textContent = ' 生成失敗';
                }
            }

            async function generateRecommendationWithDualAI() {
                const { fileName, totalPages, analysisDate, results } = analysisReportData;
                const semanticResults = results.filter(r => {
                    const evidences = r.evidences || [];
                    return evidences.length > 0 && evidences.some(ev => ev.coreHit > 0 || ev.sim > 0.01);
                });

                // 準備發送給Dual AI Model的數據
                const aiInputData = {
                    metadata: {
                        fileName,
                        totalPages,
                        analysisDate,
                        semanticMatchCount: semanticResults.length,
                        totalArticleCount: results.length
                    },
                    analysis_summary: {
                        matched_articles: semanticResults.map(result => ({
                            article_id: result.articleData.id,
                            title: result.articleData.title,
                            category: result.articleData.category,
                            difficulty: result.articleData.difficulty,
                            evidence_count: result.evidences.length,
                            max_similarity: Math.max(...result.evidences.map(e => e.sim)),
                            key_evidence: result.evidences.slice(0, 2).map(e => ({
                                content: e.content,
                                similarity: e.sim,
                                reasoning: e.reasoning,
                                page: e.page
                            }))
                        })),
                        categories_analysis: getCategoriesAnalysis(semanticResults),
                        compliance_gaps: getComplianceGaps(results, semanticResults)
                    }
                };

                console.log(' 發送數據給Dual AI Model:', aiInputData);

                try {
                    // 調用後端dual model fusion服務進行智慧分析（改為8004，並加入備援）
                    const response = await fetch('http://localhost:8004/generate_recommendation', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            file_name: fileName,
                            total_pages: totalPages,
                            analysis_date: analysisDate,
                            results: semanticResults,
                            summary: {
                                matched_articles: semanticResults.length,
                                total_articles: results.length
                            },
                            language: 'zh-TW'
                        })
                    });

                    if (response.ok) {
                        const aiResponse = await response.json();
                        console.log(' Dual AI Model響應:', aiResponse);
                        return aiResponse;
                    } else {
                        throw new Error(`API請求失敗: ${response.status}`);
                    }
                } catch (apiError) {
                    console.warn('Dual AI API不可用，使用本地生成:', apiError);
                    // 降級為本地智慧生成
                    return generateLocalRecommendation(aiInputData);
                }
            }

            function getCategoriesAnalysis(semanticResults) {
                const categories = {};
                semanticResults.forEach(result => {
                    const category = result.articleData.category;
                    if (!categories[category]) {
                        categories[category] = {
                            count: 0,
                            avg_similarity: 0,
                            articles: []
                        };
                    }
                    categories[category].count++;
                    categories[category].articles.push({
                        id: result.articleData.id,
                        title: result.articleData.title,
                        max_similarity: Math.max(...result.evidences.map(e => e.sim))
                    });
                });
                
                // 計算平均相似度
                Object.keys(categories).forEach(category => {
                    const avgSim = categories[category].articles.reduce((sum, art) => sum + art.max_similarity, 0) / categories[category].articles.length;
                    categories[category].avg_similarity = avgSim;
                });

                return categories;
            }

            function getComplianceGaps(allResults, semanticResults) {
                const matchedIds = new Set(semanticResults.map(r => r.articleData.id));
                const gaps = allResults.filter(r => !matchedIds.has(r.articleData.id));
                
                return gaps.map(gap => ({
                    article_id: gap.articleData.id,
                    title: gap.articleData.title,
                    category: gap.articleData.category,
                    difficulty: gap.articleData.difficulty,
                    reason: gap.evidences.length === 0 ? "無語義證據" : "相似度過低"
                }));
            }

            function generateLocalRecommendation(inputData) {
                // 本地智慧生成建議書 (備援模式)
                console.log(' 使用本地生成模式');
                
                const { metadata, analysis_summary } = inputData;
                const { matched_articles, categories_analysis, compliance_gaps } = analysis_summary;

                // 生成建議書結構
                const recommendation = {
                    title: `${metadata.fileName} - IFRS S1 永續資訊揭露建議書`,
                    generated_at: new Date().toISOString(),
                    model_used: "local-intelligent-generation",
                    sections: {
                        executive_summary: generateExecutiveSummary(metadata, analysis_summary),
                        compliance_status: generateComplianceStatus(matched_articles, categories_analysis),
                        gap_analysis: generateGapAnalysis(compliance_gaps),
                        recommendations: generateRecommendations(categories_analysis, compliance_gaps),
                        action_plan: generateActionPlan(categories_analysis, compliance_gaps),
                        evidence_detail: generateEvidenceDetail(matched_articles)
                    }
                };

                return recommendation;
            }

            function generateExecutiveSummary(metadata, analysis_summary) {
                const { matched_articles, compliance_gaps } = analysis_summary;
                const complianceRate = (matched_articles.length / (matched_articles.length + compliance_gaps.length) * 100).toFixed(1);
                
                return {
                    title: "執行摘要",
                    content: `
                        <p>本報告針對「${metadata.fileName}」進行IFRS S1永續相關財務資訊揭露標準的合規性分析。經由雙AI模型語義分析，發現該報告在永續資訊揭露方面的整體合規率為<strong>${complianceRate}%</strong>。</p>
                        
                        <div class="recommendation-highlight">
                            <strong>關鍵發現：</strong>
                            <ul>
                                <li>共識別出 ${matched_articles.length} 項符合IFRS S1標準的揭露內容</li>
                                <li>需要改進的領域：${compliance_gaps.length} 項條文缺乏充分證據</li>
                                <li>報告總頁數：${metadata.totalPages} 頁</li>
                                <li>分析完成時間：${new Date(metadata.analysisDate).toLocaleDateString()}</li>
                            </ul>
                        </div>
                        
                        <p>建議優先關注<strong>治理結構</strong>和<strong>風險管理</strong>領域的資訊揭露，以提升整體合規水準。</p>
                    `
                };
            }

            function generateComplianceStatus(matched_articles, categories_analysis) {
                let statusContent = `
                    <p>根據IFRS S1標準的四大支柱分析，各類別合規狀況如下：</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0;">
                `;

                Object.entries(categories_analysis).forEach(([category, data]) => {
                    const icon = getCategoryIcon(category);
                    const score = (data.avg_similarity * 100).toFixed(1);
                    const level = score >= 70 ? '優秀' : score >= 50 ? '良好' : score >= 30 ? '待改善' : '不足';
                    const color = score >= 70 ? '#4CAF50' : score >= 50 ? '#FF9800' : score >= 30 ? '#FF5722' : '#D32F2F';
                    
                    statusContent += `
                        <div style="background: white; border: 2px solid ${color}; border-radius: 12px; padding: 20px; text-align: center;">
                            <div style="font-size: 2em; margin-bottom: 10px;">${icon}</div>
                            <h4 style="margin: 10px 0; color: ${color};">${category}</h4>
                            <div style="font-size: 1.2em; font-weight: bold; color: ${color};">${score}%</div>
                            <div style="font-size: 0.9em; color: #666;">${level} (${data.count}項)</div>
                        </div>
                    `;
                });

                statusContent += `</div>`;
                
                return {
                    title: "合規狀況分析",
                    content: statusContent
                };
            }

            function generateGapAnalysis(compliance_gaps) {
                if (compliance_gaps.length === 0) {
                    return {
                        title: "差距分析",
                        content: `
                            <div class="recommendation-highlight">
                                <strong> 恭喜！</strong> 您的報告已涵蓋所有重要的IFRS S1揭露要求，未發現重大合規差距。
                            </div>
                        `
                    };
                }

                let gapContent = `
                    <p>以下 ${compliance_gaps.length} 項IFRS S1條文在當前報告中缺乏充分的語義證據：</p>
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 20px; margin: 20px 0;">
                `;

                compliance_gaps.slice(0, 8).forEach((gap, index) => {
                    const priority = gap.difficulty === 'high' ? ' 高' : gap.difficulty === 'medium' ? '🟡 中' : '🟢 低';
                    gapContent += `
                        <div style="margin-bottom: 15px; padding: 10px; background: white; border-radius: 6px;">
                            <strong>${gap.article_id}:</strong> ${gap.title}
                            <br><small style="color: #666;">類別: ${gap.category} | 優先級: ${priority} | 原因: ${gap.reason}</small>
                        </div>
                    `;
                });

                if (compliance_gaps.length > 8) {
                    gapContent += `<p><em>...還有 ${compliance_gaps.length - 8} 項其他條文需要關注</em></p>`;
                }

                gapContent += `</div>`;

                return {
                    title: "差距分析",
                    content: gapContent
                };
            }

            function generateRecommendations(categories_analysis, compliance_gaps) {
                let recommendations = [];

                // 基於類別分析生成建議
                Object.entries(categories_analysis).forEach(([category, data]) => {
                    if (data.avg_similarity < 0.5) {
                        recommendations.push(`加強<strong>${category}</strong>領域的資訊揭露，目前平均合規度僅${(data.avg_similarity * 100).toFixed(1)}%`);
                    }
                });

                // 基於差距分析生成建議
                const highPriorityGaps = compliance_gaps.filter(gap => gap.difficulty === 'high');
                if (highPriorityGaps.length > 0) {
                    recommendations.push(`優先處理 ${highPriorityGaps.length} 項高優先級條文的合規問題`);
                }

                // 通用建議
                recommendations.push(
                    "建立完整的永續資訊管理系統，確保數據收集的完整性和準確性",
                    "強化內部控制制度，建立永續資訊的審核和驗證機制",
                    "定期檢視IFRS S1標準的更新，確保揭露內容與最新要求一致"
                );

                let recContent = `<ol>`;
                recommendations.forEach(rec => {
                    recContent += `<li style="margin-bottom: 10px;">${rec}</li>`;
                });
                recContent += `</ol>`;

                return {
                    title: "改善建議",
                    content: recContent
                };
            }

            function generateActionPlan(categories_analysis, compliance_gaps) {
                const actions = [
                    {
                        phase: "第一階段 (1-3個月)",
                        icon: "",
                        tasks: [
                            "完成高優先級條文的資訊收集",
                            "建立永續資訊披露工作小組",
                            "制定詳細的合規時程表"
                        ]
                    },
                    {
                        phase: "第二階段 (3-6個月)",
                        icon: "",
                        tasks: [
                            "實施資訊管理系統升級",
                            "完成中等優先級條文的合規改善",
                            "建立內部審核制度"
                        ]
                    },
                    {
                        phase: "第三階段 (6-12個月)",
                        icon: "",
                        tasks: [
                            "完成所有條文的合規檢查",
                            "發布完整的IFRS S1合規報告",
                            "建立持續改善機制"
                        ]
                    }
                ];

                let actionContent = "";
                actions.forEach(action => {
                    actionContent += `
                        <div class="recommendation-evidence">
                            <h4>${action.icon} ${action.phase}</h4>
                            <ul>
                                ${action.tasks.map(task => `<li>${task}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                });

                return {
                    title: "行動計畫",
                    content: actionContent
                };
            }

            function generateEvidenceDetail(matched_articles) {
                let evidenceContent = `
                    <p>以下為具有高度語義證據的IFRS S1條文匹配詳情：</p>
                `;

                matched_articles.slice(0, 5).forEach(article => {
                    evidenceContent += `
                        <div class="recommendation-evidence">
                            <div class="recommendation-evidence-title">
                                ${article.article_id}: ${article.title}
                            </div>
                            <p><strong>類別：</strong>${article.category} | <strong>最高相似度：</strong>${(article.max_similarity * 100).toFixed(1)}%</p>
                            <div style="margin-top: 10px;">
                                <strong>關鍵證據：</strong>
                                <ul>
                                    ${article.key_evidence.map(ev => `
                                        <li style="margin-bottom: 5px;">
                                            [頁${ev.page}] ${ev.content.substring(0, 100)}... (相似度: ${(ev.similarity * 100).toFixed(1)}%)
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                });

                if (matched_articles.length > 5) {
                    evidenceContent += `<p><em>...共 ${matched_articles.length} 項條文有語義證據支持</em></p>`;
                }

                return {
                    title: "證據詳情",
                    content: evidenceContent
                };
            }

            function getCategoryIcon(category) {
                const icons = {
                    '治理': '',
                    '策略': '',
                    '風險管理': '',
                    '指標與目標': '',
                    '報告基礎': ''
                };
                return icons[category] || '';
            }

            function displayRecommendation(recommendationData) {
                const { title, sections } = recommendationData;
                
                let contentHTML = `
                    <div class="recommendation-document">
                        <h1>${title}</h1>
                        <p style="text-align: center; color: #666; font-style: italic;">
                            生成時間: ${new Date().toLocaleString()} | 
                            基於: 雙AI模型語義分析 (EmbeddingGemma + Qwen3)
                        </p>
                `;

                // 渲染各個章節
                Object.entries(sections).forEach(([key, section]) => {
                    contentHTML += `
                        <h2>${section.title}</h2>
                        ${section.content}
                    `;
                });

                contentHTML += `
                        <div style="margin-top: 50px; padding: 20px; background: #f8f9ff; border-radius: 8px; border: 1px solid #e1e5e9;">
                            <h3> AI生成說明</h3>
                            <p>本建議書由雙AI模型 (EmbeddingGemma-300M + Qwen3-Embedding-0.6B) 基於語義分析結果自動生成。建議內容僅供參考，實際執行時請結合企業具體情況和專業顧問意見。</p>
                            <p><strong>技術架構：</strong>雙模型融合語義分析 + 智慧內容生成</p>
                            <p><strong>生成版本：</strong>IFRS S1 ESG 報告分析工具 v6.0</p>
                        </div>
                    </div>
                `;

                document.getElementById('recommendationContent').innerHTML = contentHTML;
            }

            function closeRecommendationModal() {
                document.getElementById('recommendationModal').style.display = 'none';
            }

            function regenerateRecommendation() {
                if (confirm('確定要重新生成建議書嗎？這將覆蓋當前內容。')) {
                    generateIFRSRecommendation();
                }
            }

            function downloadRecommendationReport() {
                if (!currentRecommendationData) {
                    alert('沒有可下載的建議書數據');
                    return;
                }

                const { fileName } = analysisReportData;
                const documentContent = document.getElementById('recommendationContent').innerHTML;
                
                const fullHTML = `
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IFRS S1 建議書 - ${fileName}</title>
    <style>
        body { font-family: 'Microsoft JhengHei', 'Times New Roman', serif; line-height: 1.8; margin: 20px; color: #333; }
        .recommendation-document h1 { text-align: center; color: #1a73e8; border-bottom: 3px solid #1a73e8; padding-bottom: 20px; margin-bottom: 30px; }
        .recommendation-document h2 { color: #34a853; margin-top: 40px; margin-bottom: 20px; border-left: 4px solid #34a853; padding-left: 15px; }
        .recommendation-document h3 { color: #ea4335; margin-top: 25px; margin-bottom: 15px; }
        .recommendation-highlight { background: linear-gradient(120deg, #a8e6cf 0%, #dcedc8 100%); padding: 20px; border-radius: 8px; border-left: 4px solid #4CAF50; margin: 20px 0; }
        .recommendation-evidence { background: #f8f9ff; border: 1px solid #e8eaed; border-radius: 8px; padding: 15px; margin: 15px 0; }
        .recommendation-evidence-title { font-weight: 600; color: #1a73e8; margin-bottom: 10px; }
        @media print { body { font-size: 12px; } .no-print { display: none; } }
    </style>
</head>
<body>
    ${documentContent}
    <div class="no-print" style="margin-top: 30px; font-size: 0.9em; color: #666; text-align: center;">
        下載時間: ${new Date().toLocaleString()} | IFRS S1 ESG 報告分析工具 v6.0
    </div>
</body>
</html>`;

                downloadFile(fullHTML, `IFRS_S1_建議書_${fileName}_${new Date().toISOString().split('T')[0]}.html`, 'text/html');
            }

            function printRecommendationReport() {
                if (!currentRecommendationData) {
                    alert('沒有可列印的建議書');
                    return;
                }

                const printWindow = window.open('', '_blank');
                const documentContent = document.getElementById('recommendationContent').innerHTML;
                
                printWindow.document.write(`
<!DOCTYPE html>
<html>
<head>
    <title>IFRS S1 建議書 - ${analysisReportData.fileName}</title>
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; line-height: 1.6; margin: 20px; }
        .recommendation-document h1 { text-align: center; color: #1a73e8; border-bottom: 2px solid #1a73e8; padding-bottom: 15px; }
        .recommendation-document h2 { color: #34a853; margin-top: 30px; border-left: 4px solid #34a853; padding-left: 10px; }
        .recommendation-highlight { background: #f0f8ff; padding: 15px; border: 1px solid #1a73e8; border-radius: 4px; margin: 15px 0; }
        .recommendation-evidence { background: #f8f9ff; border: 1px solid #e8eaed; border-radius: 4px; padding: 10px; margin: 10px 0; }
        @page { margin: 1in; }
        @media print { body { font-size: 11px; } }
    </style>
</head>
<body>
    ${documentContent}
    <div style="margin-top: 30px; font-size: 0.9em; color: #666;">
        列印時間: ${new Date().toLocaleString()}
    </div>
</body>
</html>`);
                
                printWindow.document.close();
                printWindow.focus();
                
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                }, 500);
            }

            // 點擊模態窗口外部關閉
            window.onclick = function(event) {
                const modal = document.getElementById('recommendationModal');
                if (event.target === modal) {
                    closeRecommendationModal();
                }
            };

            // Function to load Chinese fonts if not available
            async function loadChineseFonts() {
                const fonts = [
                    { name: 'Microsoft JhengHei', url: 'https://fonts.gstatic.com/s/jetbrainsmono/v13/tDbY2o9AswtU38rmzDUnwv1sK9gbWtRj7wP9kKJ4.ttf' },
                    { name: 'Microsoft YaHei', url: 'https://fonts.gstatic.com/s/notosanssc/v36/k3kXo84MPvpLmixcA63oeALhL4iJ-Q7m8w.otf' },
                    { name: 'SimHei', url: 'https://fonts.gstatic.com/s/notosanssc/v36/k3kXo84MPvpLmixcA63oeALhL4iJ-Q7m8w.otf' },
                    { name: 'SimSun', url: 'https://fonts.gstatic.com/s/notosanssc/v36/k3kXo84MPvpLmixcA63oeALhL4iJ-Q7m8w.otf' }
                ];

                const fontPromises = fonts.map(font => {
                    return new Promise((resolve) => {
                        // Check if font is already loaded
                        if (document.fonts.check(`16px "${font.name}"`)) {
                            return resolve();
                        }
                        
                        // Load font if not available
                        const fontFace = new FontFace(font.name, `url(${font.url})`);
                        document.fonts.add(fontFace);
                        
                        fontFace.loaded.then(() => {
                            console.log(`[FONT] ${font.name} loaded successfully`);
                            resolve();
                        }).catch(err => {
                            console.warn(`[FONT] Failed to load ${font.name}:`, err);
                            resolve(); // Resolve anyway to not block the app
                        });
                    });
                });

                return Promise.all(fontPromises);
            }

            // --- Main Execution ---
            (async () => {
                initializeIFRSData();
                await initializeSystemStatus();
                setupEventListeners();
                await loadChineseFonts();
                // Do not block the main thread on preloading PDFs; update UI asynchronously
                preloadPDFFiles();
                console.log(' IFRS S1 分析工具已就緒');
                // 檢查後端語義服務狀態並顯示模型/設備信息
                try {
                    const res = await fetchWithTimeout('http://localhost:8004/health', { cache: 'no-store' }, 6000);
                    if (res.ok) {
                        const info = await res.json();
                        const device = info.device || 'cpu';
                        let model = 'semantic-service';
                        if (info.models && info.models.faiss_retrieval) {
                            model = 'faiss-hybrid-accelerated';
                        } else if (info.models && info.models.dual_fusion) {
                            model = 'dual-gemma-qwen3-fused';
                        }
                        
                        // 顯示硬體加速狀態
                        const statusDiv = document.getElementById('hardware-acceleration-status');
                        const detailsDiv = document.getElementById('acceleration-details');
                        
                        if (statusDiv && detailsDiv) {
                            let accelerationInfo = '';
                            if (device === 'mps') {
                                accelerationInfo = ' MPS (Metal Performance Shaders) 加速已啟用<br> 使用 Apple Silicon NPU 進行語義計算';
                            } else if (device === 'cuda') {
                                accelerationInfo = ' CUDA GPU 加速已啟用<br> 使用 NVIDIA GPU 進行語義計算';
                            } else {
                                accelerationInfo = `ℹ️ 使用 ${device.toUpperCase()} 運算<br> 已載入 ${info.indexed_articles || 0} 條 IFRS S1 條文`;
                            }
                            
                            if (info.models && info.models.faiss_retrieval) {
                                accelerationInfo += '<br> FAISS 向量檢索已優化<br> Sentence Transformers 語義模型已載入';
                            }
                            
                            detailsDiv.innerHTML = accelerationInfo;
                            statusDiv.style.display = 'block';
                        }
                        
                        document.getElementById('status-semantic').textContent = `Online (${model}, ${device})`;
                    } else {
                        document.getElementById('status-semantic').textContent = 'Offline';
                    }
                } catch (e) {
                    const el = document.getElementById('status-semantic');
                    if (el && (!el.textContent || el.textContent.includes('Checking'))) {
                        el.textContent = 'Offline (使用關鍵詞匹配)';
                    }
                }
            })();
        });
    </script>
</body>
</html>
